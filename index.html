<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRA - Gestor de Conductor ðŸš–</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root { --primary:#007bff; --secondary:#6c757d; --bg:#f4f4f9; --card-bg:#fff; }
body { margin:0; font-family:'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); color:#333; }
.splash { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:black; color:var(--primary); font-size:3rem; letter-spacing:.5rem; z-index:30; }
.sigra span { opacity:0; animation:fadeInLetter 2.5s forwards; }
.sigra span:nth-child(1){animation-delay:0.2s;} .sigra span:nth-child(2){animation-delay:0.3s;} .sigra span:nth-child(3){animation-delay:0.4s;} .sigra span:nth-child(4){animation-delay:0.5s;} .sigra span:nth-child(5){animation-delay:0.6s;}
@keyframes fadeInLetter { from {opacity:0; filter:blur(4px);} to {opacity:1; filter:blur(0);} }
.center-wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem; }
.hidden{display:none;}
.pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#eef4ff; color:var(--primary); font-weight:600;}
.list{max-height:260px; overflow:auto; padding:8px; background:#fafafa; border-radius:8px;}
.modal .content{background:var(--card-bg); padding:1rem; border-radius:10px; max-width:720px; max-height:80vh; overflow:auto;}
</style>

<!-- LibrerÃ­as JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Splash -->
<div class="splash" id="splash">
  <div class="sigra">
    <span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span>
  </div>
</div>

<!-- Auth -->
<div class="center-wrap" id="authWrap">
  <div class="card shadow p-4" id="loginCard" style="max-width:420px">
    <h1 class="text-primary">SIGRA</h1>

    <!-- Login -->
    <div id="loginView">
      <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Correo" />
      <input id="loginPass" type="password" class="form-control mb-3" placeholder="ContraseÃ±a" />
      <div class="d-flex gap-2">
        <button class="btn btn-primary w-50" onclick="doLogin()">Entrar</button>
        <button class="btn btn-secondary w-50" onclick="showRegister()">Crear Cuenta</button>
      </div>
      <p class="small text-muted mt-2">Al continuar aceptas nuestros 
        <a href="#" onclick="openTerms(event)">TÃ©rminos y Condiciones</a>
      </p>
    </div>

    <!-- Registro -->
    <div id="registerView" class="hidden">
      <h2>Crear Cuenta</h2>
      <div class="row g-2">
        <div class="col"><input id="regName" class="form-control" placeholder="Nombre" /></div>
        <div class="col"><input id="regLast" class="form-control" placeholder="Apellido" /></div>
      </div>
      <input id="regEmail" type="email" class="form-control mt-2" placeholder="Correo" />
      <input id="regPass" type="password" class="form-control mt-2" placeholder="ContraseÃ±a" />
      <input id="regPass2" type="password" class="form-control mt-2" placeholder="Confirmar ContraseÃ±a" />

      <div class="form-check my-2">
        <input id="acceptTerms" type="checkbox" class="form-check-input" />
        <label class="form-check-label" for="acceptTerms">
          He leÃ­do y acepto los <a href="#" onclick="openTerms(event)">TÃ©rminos y Condiciones</a>
        </label>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary w-50" onclick="createAccount()">Crear</button>
        <button class="btn btn-secondary w-50" onclick="showLogin()">Volver</button>
      </div>
    </div>

    <div class="small text-muted mt-3">
      Usuarios registrados: <span id="userCount">0</span>
    </div>
  </div>
</div>

<!-- App -->
<div class="container py-4" style="display:none" id="appWrap">
  <div class="card p-3 shadow">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="m-0">Gestor de Conductor ðŸš–</h2>
        <div class="small">Usuario: <span id="currentUserLabel" class="pill">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button onclick="openSessions()" class="btn btn-secondary">Ver sesiones</button>
        <button id="btnLogout" class="btn btn-secondary" onclick="doLogout()">Cerrar SesiÃ³n</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <h3>Calcular Ganancia</h3>
        <div class="row g-2">
          <div class="col"><input id="tarifa" class="form-control" placeholder="Tarifa (ganancia) $" /></div>
          <div class="col"><input id="tiempo" class="form-control" placeholder="Tiempo (h)" /></div>
        </div>
        <div class="row g-2">
          <div class="col"><input id="pagoCarro" class="form-control" placeholder="Pago carro $" /></div>
          <div class="col"><input id="gasolina" class="form-control" placeholder="Gasolina $" /></div>
        </div>
        <div class="row g-2">
          <div class="col"><input id="mantenimiento" class="form-control" placeholder="Mantenimiento $" /></div>
          <div class="col"><input id="otros" class="form-control" placeholder="Otros gastos $" /></div>
        </div>
        <div class="d-flex gap-2 my-2">
          <button class="btn btn-primary" onclick="calcular()">Calcular</button>
          <button class="btn btn-secondary" onclick="guardarCarrera()">Guardar Carrera</button>
        </div>
        <div id="resultado" class="list mt-2"></div>

        <h3 class="mt-3">Historial de Carreras</h3>
        <div id="historialList" class="list"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-primary" onclick="loadHistorial()">Refrescar</button>
          <button class="btn btn-secondary" id="btnPDF" onclick="exportPDF()">Exportar PDF</button>
        </div>

        <h3 class="mt-3">Precios de Combustible</h3>
        <div id="fuelList" class="list"></div>
      </div>

      <div class="col-lg-4">
        <h3>Totales acumulados</h3>
        <div id="totales" class="list mb-3"></div>

        <h3>GrÃ¡fico (gastos vs neto)</h3>
        <canvas id="grafico" style="max-width:100%;height:240px;background:#fff;padding:8px;border-radius:8px"></canvas>
      </div>
    </div>

    <footer class="text-center text-muted small mt-3">
      SIGRA â€¢ LocalStorage â€¢ Desarrollo local
    </footer>
  </div>
</div>

<!-- Modal sesiones -->
<div class="modal fade" id="sessionsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h3>Historial de sesiones</h3>
      <div id="sessionsList" class="list"></div>
      <div class="text-center mt-2">
        <button class="btn btn-secondary" onclick="closeSessions()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const USERS_KEY='sigra_users';
const SESSIONS_KEY='sigra_sessions';
const CARRERAS_KEY='sigra_carreras';
const PRECIOS_COMBUSTIBLE={g95:0.938,g90:0.896,diesel:0.845};
const sanitizeEmailKey=email=>email.trim().toLowerCase();

function readJSON(key){try{return JSON.parse(localStorage.getItem(key))||[]}catch(e){return []}}
function writeJSON(key,val){localStorage.setItem(key,JSON.stringify(val))}
function hashPass(p){return btoa(p)}
function showRegister(){document.getElementById('loginView').classList.add('hidden');document.getElementById('registerView').classList.remove('hidden')}
function showLogin(){document.getElementById('registerView').classList.add('hidden');document.getElementById('loginView').classList.remove('hidden')}
function doLogin(){
  const email=sanitizeEmailKey(document.getElementById('loginEmail').value);
  const pass=document.getElementById('loginPass').value;
  const users=readJSON(USERS_KEY);
  const u=users.find(x=>x.email===email);
  if(!u||u.password!==hashPass(pass)){alert('Correo o contraseÃ±a incorrectos');return}
  localStorage.setItem('sigra_current',email);
  recordSession(email);
  showAppForUser(email);
}
function createAccount(){
  const name=document.getElementById('regName').value.trim();
  const last=document.getElementById('regLast').value.trim();
  const email=sanitizeEmailKey(document.getElementById('regEmail').value);
  const pass=document.getElementById('regPass').value;
  const pass2=document.getElementById('regPass2').value;
  if(!name||!last||!email||!pass){alert('Completa todos los campos');return}
  if(pass!==pass2){alert('Las contraseÃ±as no coinciden');return}
  const users=readJSON(USERS_KEY);
  if(users.find(u=>u.email===email)){alert('Ya existe una cuenta con ese correo');return}
  users.push({name,last,email,password:hashPass(pass),created:new Date().toISOString()});
  writeJSON(USERS_KEY,users);
  alert('Cuenta creada. Ya puedes iniciar sesiÃ³n.');
  updateUserCount();
  showLogin();
}
function updateUserCount(){document.getElementById('userCount').innerText=readJSON(USERS_KEY).length}
function doLogout(){localStorage.removeItem('sigra_current');location.reload()}
function recordSession(email){const arr=readJSON(SESSIONS_KEY);arr.push({email,date:new Date().toISOString()});writeJSON(SESSIONS_KEY,arr)}
function openSessions(){document.getElementById('sessionsModal').classList.add('show');renderSessions()}
function closeSessions(){document.getElementById('sessionsModal').classList.remove('show')}
function renderSessions(){
  const arr=readJSON(SESSIONS_KEY);const el=document.getElementById('sessionsList');el.innerHTML='';
  if(!arr.length){el.innerHTML='<div class="small muted">No hay sesiones</div>';return}
  arr.slice().reverse().forEach(s=>{
    const d=new Date(s.date);
    const row=document.createElement('div');
    row.innerText=`${s.email} â€” ${d.toLocaleString()}`;
    el.appendChild(row);
  })
}

function getLastFuelPrice(){return PRECIOS_COMBUSTIBLE.g95}
function loadFuelPrices(){
  const el=document.getElementById('fuelList');
  el.innerHTML=`<div>95: $${PRECIOS_COMBUSTIBLE.g95.toFixed(2)}</div>
                <div>90: $${PRECIOS_COMBUSTIBLE.g90.toFixed(2)}</div>
                <div>DiÃ©sel: $${PRECIOS_COMBUSTIBLE.diesel.toFixed(2)}</div>`;
}

function calcular(){
  const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
  const gasolinaFija=getLastFuelPrice();
  const gasolina=parseFloat(document.getElementById('gasolina').value)||0;
  const pagoCarro=parseFloat(document.getElementById('pagoCarro').value)||0;
  const mantenimiento=parseFloat(document.getElementById('mantenimiento').value)||0;
  const otros=parseFloat(document.getElementById('otros').value)||0;
  const neto=tarifa-(gasolinaFija+gasolina+pagoCarro+mantenimiento+otros);
  document.getElementById('resultado').innerText='Ganancia estimada: $'+neto.toFixed(2);
}

function guardarCarrera(){
  const email=localStorage.getItem('sigra_current'); if(!email){alert('No estÃ¡s logueado');return;}
  const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
  const gasolinaFija=getLastFuelPrice();
  const gasolina=parseFloat(document.getElementById('gasolina').value)||0;
  const pagoCarro=parseFloat(document.getElementById('pagoCarro').value)||0;
  const mantenimiento=parseFloat(document.getElementById('mantenimiento').value)||0;
  const otros=parseFloat(document.getElementById('otros').value)||0;
  const neto=tarifa-(gasolinaFija+gasolina+pagoCarro+mantenimiento+otros);
  const arr=readJSON(CARRERAS_KEY);
  arr.push({email,date:new Date().toISOString(),tarifa,gasolinaFija,gasolina,pagoCarro,mantenimiento,otros,neto});
  writeJSON(CARRERAS_KEY,arr);
  loadHistorial(); loadTotals(); renderChart();
  alert('Carrera guardada');
}

function loadHistorial(){
  const arr=readJSON(CARRERAS_KEY); const el=document.getElementById('historialList'); el.innerHTML='';
  const current=localStorage.getItem('sigra_current');
  arr.filter(x=>x.email===current).slice().reverse().forEach(c=>{
    const d=new Date(c.date);
    const row=document.createElement('div');
    row.innerText=`${d.toLocaleDateString()} â€” Neto: $${c.neto.toFixed(2)}`;
    el.appendChild(row);
  })
}

function loadTotals(){
  const arr=readJSON(CARRERAS_KEY); const current=localStorage.getItem('sigra_current');
  const totales=arr.filter(x=>x.email===current).reduce((acc,v)=>{
    acc.neto+=v.neto; acc.gasolina+=v.gasolinaFija+v.gasolina; acc.carro+=v.pagoCarro; acc.mantenimiento+=v.mantenimiento; acc.otros+=v.otros;
    return acc;
  },{neto:0,gasolina:0,carro:0,mantenimiento:0,otros:0});
  const el=document.getElementById('totales');
  el.innerHTML=`<div>Neto: $${totales.neto.toFixed(2)}</div>
                <div>Gasolina: $${totales.gasolina.toFixed(2)}</div>
                <div>Pago carro: $${totales.carro.toFixed(2)}</div>
                <div>Mantenimiento: $${totales.mantenimiento.toFixed(2)}</div>
                <div>Otros: $${totales.otros.toFixed(2)}</div>`;
}

function renderChart(){
  const ctx=document.getElementById('grafico').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  const arr=readJSON(CARRERAS_KEY).filter(x=>x.email===localStorage.getItem('sigra_current')).slice(-10);
  const labels=arr.map(c=>new Date(c.date).toLocaleDateString());
  const neto=arr.map(c=>c.neto);
  const gastos=arr.map(c=>c.gasolinaFija+c.gasolina+c.pagoCarro+c.mantenimiento+c.otros);

  window.myChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Neto', data:neto, backgroundColor:'var(--primary)'},
      {label:'Gastos', data:gastos, backgroundColor:'var(--secondary)'}
    ]},
    options:{
      responsive:true,
      plugins:{
        legend:{position:'top'},
        datalabels:{
          anchor:'end',
          align:'top',
          color:'#000',
          font:{weight:'bold'},
          formatter: val=>`$${val.toFixed(2)}`
        }
      },
      scales:{y:{beginAtZero:true}}
    },
    plugins:[ChartDataLabels]
  });
}

function exportPDF(){
  const { jsPDF }=window.jspdf;
  const carreras=readJSON(CARRERAS_KEY).filter(c=>c.email===localStorage.getItem('sigra_current'));
  if(!carreras.length){alert('No hay carreras para exportar');return;}
  const doc=new jsPDF();
  doc.setFontSize(18);
  doc.text("Historial de Carreras - SIGRA",14,20);
  const tableData=carreras.map(c=>[
    new Date(c.date).toLocaleString(),
    `$${c.tarifa.toFixed(2)}`,
    `$${(c.gasolinaFija+c.gasolina).toFixed(2)}`,
    `$${c.pagoCarro.toFixed(2)}`,
    `$${c.mantenimiento.toFixed(2)}`,
    `$${c.otros.toFixed(2)}`,
    `$${c.neto.toFixed(2)}`
  ]);
  doc.autoTable({startY:30, head:[['Fecha','Tarifa','Gasolina','Pago carro','Mantenimiento','Otros','Neto']], body:tableData});
  doc.save('historial_SIGRA.pdf');
}

function showAppForUser(email){
  document.getElementById('authWrap').style.display='none';
  document.getElementById('appWrap').style.display='block';
  document.getElementById('currentUserLabel').innerText=email;
  loadHistorial(); loadTotals(); loadFuelPrices(); renderChart();
}

window.addEventListener('load',()=>{
  setTimeout(()=>{
    document.getElementById('splash').style.opacity=0;
    setTimeout(()=>{
      document.getElementById('splash').style.display='none';
      updateUserCount();
    },500)
  },1500)
})
</script>
</body>
</html>
