<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRA - Gestor de Conductor üöñ</title>
<!-- Fuente Hollow Knight-like -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root { 
  --primary:#00ffa6; 
  --secondary:#00b7ff; 
  --bg:#0d1117; 
  --card-bg:#161b22; 
  --input-bg:#0d1117;
  --list-bg:#0d1117;
  --canvas-bg:#0d1117;
  --border-color:#222;
  --border-input:#333;
  --text-color:#e6e6e6;
  --text-muted:#888;
  --text-small:#aaa;
}

/* Tema claro */
.light-theme {
  --bg: #f5f5dc; /* Blanco hueso */
  --card-bg: #ffffff; /* Tarjetas blancas */
  --input-bg: #ffffff;
  --list-bg: #f8f9fa;
  --canvas-bg: #f8f9fa;
  --border-color: #ddd;
  --border-input: #ccc;
  --text-color: #333333;
  --text-muted: #666666;
  --text-small: #555555;
}

body { 
  margin:0; 
  font-family:'Cinzel', serif; 
  background:var(--bg); 
  color:var(--text-color); 
  transition: background-color 0.3s ease, color 0.3s ease;
}

.splash { 
  position:fixed; 
  inset:0; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  background:black; 
  color:var(--primary); 
  font-size:3rem; 
  letter-spacing:.5rem; 
  z-index:30; 
}

.sigra span { 
  opacity:0; 
  animation:fadeInLetter 2.5s forwards; 
}
.sigra span:nth-child(1){animation-delay:0.2s;} 
.sigra span:nth-child(2){animation-delay:0.3s;} 
.sigra span:nth-child(3){animation-delay:0.4s;} 
.sigra span:nth-child(4){animation-delay:0.5s;} 
.sigra span:nth-child(5){animation-delay:0.6s;}

@keyframes fadeInLetter { 
  from {opacity:0; filter:blur(4px);} 
  to {opacity:1; filter:blur(0);} 
}

.center-wrap { 
  min-height:100vh; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  padding:1rem; 
}

.card { 
  width:100%; 
  max-width:920px; 
  background:var(--card-bg); 
  padding:1.25rem; 
  border-radius:12px; 
  box-shadow:0 6px 20px rgba(0,0,0,.5); 
  border:1px solid var(--primary);
}

.hidden{display:none;}
h1,h2,h3{margin:.25rem 0;}
.row{display:flex;gap:12px;}
.col{flex:1;}
input, select, button, textarea { 
  width:100%; 
  padding:10px; 
  margin:6px 0; 
  border-radius:8px; 
  border:1px solid var(--border-input); 
  font-size:15px;
  background:var(--input-bg);
  color:var(--text-color);
  transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}
button{
  background:var(--primary); 
  color:#0d1117; 
  border:none; 
  cursor:pointer; 
  font-weight:bold;
}
button.secondary{
  background:var(--secondary); 
  color:#0d1117;
}

/* Bot√≥n de tema */
.theme-toggle {
  background: #333;
  color: #fff;
  border: 1px solid #555;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  margin-left: 10px;
}

.theme-toggle:hover {
  background: #555;
}

.topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.small{font-size:.9rem; color:var(--text-small);}
.muted{color:var(--text-muted);}
.grid{display:grid; grid-template-columns:1fr 340px; gap:12px;}
.list{max-height:260px; overflow:auto; padding:8px; background:var(--list-bg); border-radius:8px; border:1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;}
table{width:100%; border-collapse:collapse;}
table td, table th{padding:6px; border-bottom:1px solid var(--border-color);}
.actions{display:flex; gap:8px; align-items:center;}
.pill{display:inline-block; padding:6px 10px; border-radius:999px; background:var(--list-bg); color:var(--primary); font-weight:600; border:1px solid var(--primary); transition: background-color 0.3s ease;}
footer{margin-top:12px; text-align:center; color:var(--text-muted); font-size:.85rem;}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; visibility:hidden; opacity:0; transition:all .2s; z-index:50;}
.modal.show{visibility:visible; opacity:1;}
.modal .content{background:var(--card-bg); padding:1rem; border-radius:10px; max-width:720px; max-height:80vh; overflow:auto; transition: background-color 0.3s ease;}
.right{text-align:right;}
.terms-content{max-height:400px; overflow-y:auto; background:var(--list-bg); padding:15px; border-radius:8px; border:1px solid var(--border-color); margin:10px 0; line-height:1.5; transition: background-color 0.3s ease, border-color 0.3s ease;}
.terms-buttons{display:flex; gap:10px; justify-content:center; margin-top:15px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Splash -->
<div class="splash" id="splash">
  <div class="sigra">
    <span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span>
  </div>
</div>

<!-- Auth -->
<div class="center-wrap" id="authWrap">
  <div class="card" id="loginCard">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h1 style="color:var(--primary); margin: 0;">SIGRA</h1>
      <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">üåô</button>
    </div>
    <div id="loginView">
      <input id="loginEmail" type="email" placeholder="Correo" />
      <input id="loginPass" type="password" placeholder="Contrase√±a" />
      <div class="row">
        <button onclick="doLogin()">Entrar</button>
        <button class="secondary" onclick="showRegister()">Crear Cuenta</button>
      </div>
      <p class="small muted">Al continuar aceptas nuestros <a href="#" onclick="openTerms(event)">T√©rminos y Condiciones</a></p>
    </div>
    <div id="registerView" class="hidden">
      <h2>Crear Cuenta</h2>
      <div class="row">
        <input id="regName" placeholder="Nombre" />
        <input id="regLast" placeholder="Apellido" />
      </div>
      <input id="regEmail" type="email" placeholder="Correo" />
      <input id="regPass" type="password" placeholder="Contrase√±a" />
      <input id="regPass2" type="password" placeholder="Confirmar Contrase√±a" />
      <div style="margin:8px 0" class="terms-checkbox">
        <input id="acceptTerms" type="checkbox" />
        <label for="acceptTerms">He le√≠do y acepto los <a href="#" onclick="openTerms(event)">T√©rminos y Condiciones</a></label>
      </div>
      <div class="row">
        <button onclick="createAccount()">Crear</button>
        <button class="secondary" onclick="showLogin()">Volver</button>
      </div>
    </div>
    <div style="margin-top:10px" class="small muted">Usuarios registrados: <span id="userCount">0</span></div>
  </div>
</div>

<!-- App -->
<div style="display:none;padding:18px" id="appWrap">
  <div class="card">
    <div class="topbar">
      <div>
        <h2 style="margin:0">Gestor de Conductor üöñ</h2>
        <div class="small">Usuario: <span id="currentUserLabel" class="pill">-</span></div>
      </div>
      <div class="actions">
        <button onclick="openSessions()" class="secondary">Ver sesiones</button>
        <button id="btnLogout" class="secondary" onclick="doLogout()">Cerrar Sesi√≥n</button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">üåô</button>
      </div>
    </div>

    <div class="grid">
      <div>
        <div style="margin-bottom:12px">
          <h3>Calcular Ganancia</h3>
          <div class="row">
            <input id="tarifa" placeholder="Tarifa (ganancia) $" />
            <input id="tiempo" placeholder="Tiempo (h)" />
          </div>
          <div class="row">
            <input id="pagoCarro" placeholder="Pago carro $" />
            <input id="gasolina" placeholder="Gasolina $" />
          </div>
          <div class="row">
            <input id="mantenimiento" placeholder="Mantenimiento $" />
            <input id="otros" placeholder="Otros gastos $" />
          </div>
          <div class="row">
            <button onclick="calcular()">Calcular</button>
            <button class="secondary" onclick="guardar()">Guardar </button>
          </div>
          <div id="resultado" class="list" style="margin-top:8px"></div>
        </div>

        <div style="margin-bottom:12px">
          <h3>Historial de Carreras</h3>
          <div id="historialList" class="list"></div>
          <div style="margin-top:8px" class="row">
            <button onclick="loadHistorial()">Refrescar</button>
            <button class="secondary" id="btnPDF" onclick="exportPDF()">Exportar PDF</button>
          </div>
        </div>

        <div>
          <h3>Precios de Combustible</h3>
          <div id="fuelList" class="list"></div>
        </div>
      </div>

      <div>
        <div style="margin-bottom:12px">
          <h3>Totales acumulados</h3>
          <div id="totales" class="list"></div>
        </div>

        <div>
          <h3>Gr√°fico (gastos vs neto)</h3>
          <canvas id="grafico" style="max-width:100%;height:240px;background:var(--canvas-bg);padding:8px;border-radius:8px;border:1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;"></canvas>
        </div>
      </div>
    </div>

    <footer>SIGRA ‚Ä¢ LocalStorage ‚Ä¢ Desarrollo local</footer>
  </div>
</div>

<div class="modal" id="sessionsModal">
  <div class="content">
    <h3>Historial de sesiones</h3>
    <div id="sessionsList" class="list"></div>
    <div style="text-align:center;margin-top:8px"><button onclick="closeSessions()">Cerrar</button></div>
  </div>
</div>

<!-- Modal de T√©rminos y Condiciones -->
<div class="modal" id="termsModal">
  <div class="content" style="max-width:800px">
    <h3 style="color:var(--primary); text-align:center;">T√âRMINOS Y CONDICIONES DE USO</h3>
    <div class="terms-content">
      <p><strong>Bienvenido a nuestra p√°gina. Al utilizar esta p√°gina, usted acepta los siguientes t√©rminos y condiciones. Lea atentamente antes de continuar.</strong></p>
      
      <p><strong>1. Protecci√≥n de datos personales</strong><br>
      La p√°gina se compromete a resguardar toda informaci√≥n personal proporcionada por los usuarios, incluyendo nombres, correos electr√≥nicos, datos de contacto y financieros. Bajo ninguna circunstancia esta informaci√≥n ser√° cedida, vendida o compartida con terceros, salvo que medie una orden judicial v√°lida emitida por una instituci√≥n jur√≠dica competente.</p>
      
      <p><strong>2. Uso de la informaci√≥n</strong><br>
      La informaci√≥n proporcionada ser√° utilizada √∫nicamente para mejorar la experiencia del usuario, permitir el acceso a funcionalidades de la p√°gina, y asegurar el correcto funcionamiento de los servicios ofrecidos.</p>
      
      <p><strong>3. Responsabilidad del usuario</strong><br>
      El usuario se compromete a proporcionar informaci√≥n veraz y completa al registrarse y usar los servicios. Cualquier informaci√≥n falsa o incompleta puede resultar en la suspensi√≥n o eliminaci√≥n de su cuenta.</p>
      
      <p><strong>4. Seguridad de la informaci√≥n</strong><br>
      La p√°gina implementa medidas de seguridad t√©cnicas y organizativas para proteger los datos del usuario frente a accesos no autorizados, p√©rdida, alteraci√≥n o divulgaci√≥n indebida. Sin embargo, el usuario reconoce que ning√∫n sistema de almacenamiento o transmisi√≥n de datos es completamente infalible.</p>
      
      <p><strong>5. Acceso y uso del servicio</strong><br>
      La p√°gina se reserva el derecho de modificar, suspender o interrumpir temporal o permanentemente los servicios, en cualquier momento y sin previo aviso.</p>
      
      <p><strong>6. Contenido de la p√°gina</strong><br>
      Todo el contenido disponible en la p√°gina, incluyendo textos, gr√°ficos, dise√±os, y funcionalidades, es propiedad de la p√°gina o de sus proveedores. Queda prohibida la reproducci√≥n, distribuci√≥n o uso comercial sin autorizaci√≥n expresa.</p>
      
      <p><strong>7. Cumplimiento legal</strong><br>
      Los usuarios se comprometen a utilizar la p√°gina √∫nicamente para fines legales y de acuerdo con la legislaci√≥n vigente. Cualquier uso indebido puede derivar en acciones legales y cierre de cuentas.</p>
      
      <p><strong>8. Modificaciones a los t√©rminos</strong><br>
      La p√°gina puede actualizar estos t√©rminos y condiciones en cualquier momento. Los cambios ser√°n efectivos inmediatamente despu√©s de su publicaci√≥n en la p√°gina. Se recomienda revisar peri√≥dicamente los t√©rminos para mantenerse informado.</p>
      
      <p><strong>9. Aceptaci√≥n de los t√©rminos</strong><br>
      Al registrarse y utilizar la p√°gina, usted acepta expl√≠citamente todos los t√©rminos y condiciones aqu√≠ descritos.</p>
    </div>
    <div class="terms-buttons">
      <button onclick="acceptTermsAndRegister()" style="background:var(--primary); color:#0d1117;">Aceptar</button>
      <button class="secondary" onclick="rejectTerms()">Rechazar</button>
    </div>
  </div>
</div>

<script>
const USERS_KEY='sigra_users';
const SESSIONS_KEY='sigra_sessions';
const CARRERAS_KEY='sigra_carreras';
const THEME_KEY='sigra_theme';
const PRECIOS_COMBUSTIBLE={g95:0.938,g90:0.896,diesel:0.845};
const sanitizeEmailKey=email=>email.trim().toLowerCase();

let pendingRegistration = null;

// Funci√≥n para cambiar el tema
function toggleTheme() {
  const body = document.body;
  const themeButton = document.querySelector('.theme-toggle');
  
  if (body.classList.contains('light-theme')) {
    // Cambiar a tema oscuro
    body.classList.remove('light-theme');
    themeButton.textContent = 'üåô';
    localStorage.setItem(THEME_KEY, 'dark');
  } else {
    // Cambiar a tema claro
    body.classList.add('light-theme');
    themeButton.textContent = '‚òÄÔ∏è';
    localStorage.setItem(THEME_KEY, 'light');
  }
}

// Cargar tema guardado
function loadTheme() {
  const savedTheme = localStorage.getItem(THEME_KEY);
  const body = document.body;
  const themeButtons = document.querySelectorAll('.theme-toggle');
  
  if (savedTheme === 'light') {
    body.classList.add('light-theme');
    themeButtons.forEach(btn => btn.textContent = '‚òÄÔ∏è');
  } else {
    body.classList.remove('light-theme');
    themeButtons.forEach(btn => btn.textContent = 'üåô');
  }
}

function readJSON(key){try{return JSON.parse(localStorage.getItem(key))||[]}catch(e){return []}}
function writeJSON(key,val){localStorage.setItem(key,JSON.stringify(val))}
function hashPass(p){return btoa(p)}
function showRegister(){document.getElementById('loginView').classList.add('hidden');document.getElementById('registerView').classList.remove('hidden')}
function showLogin(){document.getElementById('registerView').classList.add('hidden');document.getElementById('loginView').classList.remove('hidden')}
function doLogin(){
  const email=sanitizeEmailKey(document.getElementById('loginEmail').value);
  const pass=document.getElementById('loginPass').value;
  const users=readJSON(USERS_KEY);
  const u=users.find(x=>x.email===email);
  if(!u||u.password!==hashPass(pass)){alert('Correo o contrase√±a incorrectos');return}
  localStorage.setItem('sigra_current',email);
  recordSession(email);
  showAppForUser(email);
}

function openTerms(event) {
  event.preventDefault();
  document.getElementById('termsModal').classList.add('show');
}

function acceptTermsAndRegister() {
  document.getElementById('termsModal').classList.remove('show');
  if (pendingRegistration) {
    proceedWithRegistration();
  } else {
    document.getElementById('acceptTerms').checked = true;
  }
}

function rejectTerms() {
  document.getElementById('termsModal').classList.remove('show');
  pendingRegistration = null;
  document.getElementById('acceptTerms').checked = false;
}

function createAccount(){
  const name=document.getElementById('regName').value.trim();
  const last=document.getElementById('regLast').value.trim();
  const email=sanitizeEmailKey(document.getElementById('regEmail').value);
  const pass=document.getElementById('regPass').value;
  const pass2=document.getElementById('regPass2').value;
  
  if(!name||!last||!email||!pass){alert('Completa todos los campos');return}

  // ‚úÖ Validaci√≥n de correo
  if(!email.endsWith("@gmail.com")){
    alert("El correo debe ser una direcci√≥n v√°lida de Gmail (ejemplo@gmail.com)");
    return;
  }

  // ‚úÖ Validaci√≥n de contrase√±a m√≠nima
  if(pass.length < 4){
    alert("La contrase√±a debe tener al menos 4 caracteres");
    return;
  }

  // ‚úÖ Confirmar contrase√±as
  if(pass!==pass2){
    alert('Las contrase√±as no coinciden');
    return;
  }

  if(!document.getElementById('acceptTerms').checked){
    pendingRegistration = {name, last, email, pass};
    openTerms(new Event('click'));
    return;
  }

  proceedWithRegistration();
}

function proceedWithRegistration() {
  const data = pendingRegistration || {
    name: document.getElementById('regName').value.trim(),
    last: document.getElementById('regLast').value.trim(),
    email: sanitizeEmailKey(document.getElementById('regEmail').value),
    pass: document.getElementById('regPass').value
  };

  const users=readJSON(USERS_KEY);
  if(users.find(u=>u.email===data.email)){alert('Ya existe una cuenta con ese correo');return}
  users.push({name:data.name,last:data.last,email:data.email,password:hashPass(data.pass),created:new Date().toISOString()});
  writeJSON(USERS_KEY,users);
  alert('Cuenta creada. Ya puedes iniciar sesi√≥n.');
  updateUserCount();
  showLogin();
  pendingRegistration = null;
}

function updateUserCount(){document.getElementById('userCount').innerText=readJSON(USERS_KEY).length}
function doLogout(){localStorage.removeItem('sigra_current');location.reload()}
function recordSession(email){const arr=readJSON(SESSIONS_KEY);arr.push({email,date:new Date().toISOString()});writeJSON(SESSIONS_KEY,arr)}
function openSessions(){document.getElementById('sessionsModal').classList.add('show');renderSessions()}
function closeSessions(){document.getElementById('sessionsModal').classList.remove('show')}
function renderSessions(){
  const arr=readJSON(SESSIONS_KEY);const el=document.getElementById('sessionsList');el.innerHTML='';
  if(!arr.length){el.innerHTML='<div class="small muted">No hay sesiones</div>';return}
  arr.slice().reverse().forEach(s=>{
    const d=new Date(s.date);
    const row=document.createElement('div');
    row.innerText=`${s.email} ‚Äî ${d.toLocaleString()}`;
    el.appendChild(row);
  })
}

function getLastFuelPrice(){return PRECIOS_COMBUSTIBLE.g95}
function loadFuelPrices(){
  const el=document.getElementById('fuelList');
  el.innerHTML=`<div>95: $${PRECIOS_COMBUSTIBLE.g95.toFixed(2)}</div>
                <div>90: $${PRECIOS_COMBUSTIBLE.g90.toFixed(2)}</div>
                <div>Di√©sel: $${PRECIOS_COMBUSTIBLE.diesel.toFixed(2)}</div>`;
}

function calcular(){
  const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
  const gasolinaFija=getLastFuelPrice();
  const gasolina=parseFloat(document.getElementById('gasolina').value)||0;
  const pagoCarro=parseFloat(document.getElementById('pagoCarro').value)||0;
  const mantenimiento=parseFloat(document.getElementById('mantenimiento').value)||0;
  const otros=parseFloat(document.getElementById('otros').value)||0;
  const neto=tarifa-(gasolinaFija+gasolina+pagoCarro+mantenimiento+otros);
  document.getElementById('resultado').innerText='Ganancia estimada: $'+neto.toFixed(2);
}

function guardar(){
  const email=localStorage.getItem('sigra_current'); if(!email){alert('No est√°s logueado');return;}
  const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
  const gasolinaFija=getLastFuelPrice();
  const gasolina=parseFloat(document.getElementById('gasolina').value)||0;
  const pagoCarro=parseFloat(document.getElementById('pagoCarro').value)||0;
  const mantenimiento=parseFloat(document.getElementById('mantenimiento').value)||0;
  const otros=parseFloat(document.getElementById('otros').value)||0;
  const neto=tarifa-(gasolinaFija+gasolina+pagoCarro+mantenimiento+otros);
  const arr=readJSON(CARRERAS_KEY);
  arr.push({email,date:new Date().toISOString(),tarifa,gasolinaFija,gasolina,pagoCarro,mantenimiento,otros,neto});
  writeJSON(CARRERAS_KEY,arr);
  loadHistorial(); loadTotals(); renderChart();
  alert('Carrera guardada');
}

function loadHistorial(){
  const arr=readJSON(CARRERAS_KEY); const el=document.getElementById('historialList'); el.innerHTML='';
  const current=localStorage.getItem('sigra_current');
  arr.filter(x=>x.email===current).slice().reverse().forEach(c=>{
    const d=new Date(c.date);
    const row=document.createElement('div');
    row.innerText=`${d.toLocaleDateString()} ‚Äî Neto: $${c.neto.toFixed(2)}`;
    el.appendChild(row);
  })
}

function loadTotals(){
  const arr=readJSON(CARRERAS_KEY); const current=localStorage.getItem('sigra_current');
  const totales=arr.filter(x=>x.email===current).reduce((acc,v)=>{
    acc.neto+=v.neto; acc.gasolina+=v.gasolinaFija+v.gasolina; acc.carro+=v.pagoCarro; acc.mantenimiento+=v.mantenimiento; acc.otros+=v.otros;
    return acc;
  },{neto:0,gasolina:0,carro:0,mantenimiento:0,otros:0});
  const el=document.getElementById('totales');
  el.innerHTML=`<div>Neto: $${totales.neto.toFixed(2)}</div>
                <div>Gasolina: $${totales.gasolina.toFixed(2)}</div>
                <div>Pago carro: $${totales.carro.toFixed(2)}</div>
                <div>Mantenimiento: $${totales.mantenimiento.toFixed(2)}</div>
                <div>Otros: $${totales.otros.toFixed(2)}</div>`;
}

function renderChart(){
  const ctx=document.getElementById('grafico').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  const arr=readJSON(CARRERAS_KEY).filter(x=>x.email===localStorage.getItem('sigra_current')).slice(-10);
  const labels=arr.map(c=>new Date(c.date).toLocaleDateString());
  const neto=arr.map(c=>c.neto);
  const gastos=arr.map(c=>c.gasolinaFija+c.gasolina+c.pagoCarro+c.mantenimiento+c.otros);

  window.myChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Neto', data:neto, backgroundColor:'var(--primary)'},
      {label:'Gastos', data:gastos, backgroundColor:'var(--secondary)'}
    ]},
    options:{
      responsive:true,
      plugins:{
        legend:{position:'top'},
        datalabels:{
          anchor:'end',
          align:'top',
          color:'#fff',
          font:{weight:'bold'},
          formatter: val=>`$${val.toFixed(2)}`
        }
      },
      scales:{y:{beginAtZero:true}}
    },
    plugins:[ChartDataLabels]
  });
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const carreras = readJSON(CARRERAS_KEY).filter(c => c.email === localStorage.getItem('sigra_current'));
    
    if (!carreras.length) {
        alert('No hay carreras para exportar');
        return;
    }

    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    // Colores profesionales
    const primaryColor = [41, 128, 185];    // Azul profesional
    const secondaryColor = [52, 73, 94];    // Gris oscuro
    const accentColor = [231, 76, 60];      // Rojo para resaltar
    const lightGray = [236, 240, 241];      // Gris claro para fondos

    // === ENCABEZADO PROFESIONAL ===
    // Fondo del encabezado
    doc.setFillColor(...primaryColor);
    doc.rect(0, 0, pageWidth, 35, 'F');

    // Logo/Icono simulado (c√≠rculo con iniciales)
    doc.setFillColor(255, 255, 255);
    doc.circle(20, 17, 8, 'F');
    doc.setFontSize(12);
    doc.setTextColor(...primaryColor);
    doc.setFont("helvetica", "bold");
    doc.text("SG", 16.5, 20.5);

    // T√≠tulo principal
    doc.setFontSize(22);
    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold");
    doc.text("HISTORIAL DE CARRERAS", 35, 18);

    // Subt√≠tulo
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text("Sistema Integral de Gesti√≥n de Rutas y An√°lisis", 35, 26);

    // === INFORMACI√ìN DEL REPORTE ===
    const currentDate = new Date().toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    doc.setTextColor(...secondaryColor);
    doc.setFontSize(10);
    doc.text(`Generado el: ${currentDate}`, 14, 45);
    doc.text(`Total de registros: ${carreras.length}`, 14, 52);
    doc.text(`Usuario: ${localStorage.getItem('sigra_current') || 'N/A'}`, 14, 59);

    // L√≠nea separadora
    doc.setDrawColor(...primaryColor);
    doc.setLineWidth(0.5);
    doc.line(14, 65, pageWidth - 14, 65);

    // === C√ÅLCULOS DE RESUMEN ===
    const totales = carreras.reduce((acc, carrera) => ({
        tarifa: acc.tarifa + carrera.tarifa,
        gasolina: acc.gasolina + (carrera.gasolinaFija + carrera.gasolina),
        pagoCarro: acc.pagoCarro + carrera.pagoCarro,
        mantenimiento: acc.mantenimiento + carrera.mantenimiento,
        otros: acc.otros + carrera.otros,
        neto: acc.neto + carrera.neto
    }), { tarifa: 0, gasolina: 0, pagoCarro: 0, mantenimiento: 0, otros: 0, neto: 0 });

    // === TABLA DE DATOS ===
    const tableData = carreras.map((c, index) => [
        (index + 1).toString(), // N√∫mero de fila
        new Date(c.date).toLocaleDateString('es-ES'),
        new Date(c.date).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
        `$${c.tarifa.toFixed(2)}`,
        `$${(c.gasolinaFija + c.gasolina).toFixed(2)}`,
        `$${c.pagoCarro.toFixed(2)}`,
        `$${c.mantenimiento.toFixed(2)}`,
        `$${c.otros.toFixed(2)}`,
        `$${c.neto.toFixed(2)}`
    ]);

    // Configuraci√≥n de la tabla principal
    doc.autoTable({
        startY: 75,
        head: [['#', 'Fecha', 'Hora', 'Tarifa', 'Gasolina', 'Pago Carro', 'Mantenimiento', 'Otros', 'Neto']],
        body: tableData,
        theme: 'striped',
        headStyles: {
            fillColor: primaryColor,
            textColor: [255, 255, 255],
            fontSize: 9,
            fontStyle: 'bold',
            halign: 'center'
        },
        bodyStyles: {
            fontSize: 8,
            textColor: secondaryColor
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 12 },
            1: { halign: 'center', cellWidth: 25 },
            2: { halign: 'center', cellWidth: 18 },
            3: { halign: 'right', cellWidth: 22 },
            4: { halign: 'right', cellWidth: 22 },
            5: { halign: 'right', cellWidth: 22 },
            6: { halign: 'right', cellWidth: 25 },
            7: { halign: 'right', cellWidth: 18 },
            8: { halign: 'right', cellWidth: 22, fontStyle: 'bold', textColor: accentColor }
        },
        margin: { left: 14, right: 14 }
    });

    // === TABLA DE TOTALES ===
    const finalY = doc.lastAutoTable.finalY + 10;
    
    // T√≠tulo de resumen
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(...secondaryColor);
    doc.text("RESUMEN FINANCIERO", 14, finalY);

    const resumenData = [
        ['Total Ingresos (Tarifas)', `$${totales.tarifa.toFixed(2)}`],
        ['Total Gasolina', `$${totales.gasolina.toFixed(2)}`],
        ['Total Pago Carro', `$${totales.pagoCarro.toFixed(2)}`],
        ['Total Mantenimiento', `$${totales.mantenimiento.toFixed(2)}`],
        ['Total Otros Gastos', `$${totales.otros.toFixed(2)}`],
        ['GANANCIA NETA TOTAL', `$${totales.neto.toFixed(2)}`]
    ];

    doc.autoTable({
        startY: finalY + 8,
        body: resumenData,
        theme: 'plain',
        bodyStyles: {
            fontSize: 11,
            textColor: secondaryColor
        },
        columnStyles: {
            0: { 
                fontStyle: 'bold',
                cellWidth: 100,
                halign: 'left'
            },
            1: { 
                fontStyle: 'bold',
                cellWidth: 40,
                halign: 'right'
            }
        },
        didParseCell: function(data) {
            // Resaltar la fila de ganancia neta
            if (data.row.index === resumenData.length - 1) {
                data.cell.styles.fillColor = primaryColor;
                data.cell.styles.textColor = [255, 255, 255];
                data.cell.styles.fontSize = 12;
            }
        },
        margin: { left: 14, right: 14 }
    });

    // === PIE DE P√ÅGINA ===
    const finalFooterY = doc.lastAutoTable.finalY + 20;
    
    // L√≠nea separadora del pie
    doc.setDrawColor(...lightGray);
    doc.setLineWidth(0.3);
    doc.line(14, finalFooterY, pageWidth - 14, finalFooterY);

    // Informaci√≥n del pie
    doc.setFontSize(9);
    doc.setTextColor(150, 150, 150);
    doc.setFont("helvetica", "normal");
    doc.text("SIGRA - Sistema Integral de Gesti√≥n de Rutas y An√°lisis", 14, finalFooterY + 8);
    doc.text(`Reporte generado autom√°ticamente el ${currentDate}`, 14, finalFooterY + 15);
    
    // N√∫mero de p√°gina
    doc.text(`P√°gina 1`, pageWidth - 30, finalFooterY + 8);

    // === GUARDAR ARCHIVO ===
    const fileName = `SIGRA_Historial_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(fileName);

    // Mensaje de confirmaci√≥n
    console.log(`PDF generado exitosamente: ${fileName}`);
}
function showAppForUser(email){
  document.getElementById('authWrap').style.display='none';
  document.getElementById('appWrap').style.display='block';
  document.getElementById('currentUserLabel').innerText=email;
  loadHistorial(); loadTotals(); loadFuelPrices(); renderChart();
}

window.addEventListener('load',()=>{
  // Cargar tema guardado
  loadTheme();
  
  setTimeout(()=>{
    document.getElementById('splash').style.opacity=0;
    setTimeout(()=>{
      document.getElementById('splash').style.display='none';
      updateUserCount();
    },500)
  },1500)
})
</script>
</body>
</html>
