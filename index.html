<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sigra - Gestor de Conductores</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5}
    header{background:#333;color:#fff;padding:10px;text-align:center}
    main{padding:20px}
    section{margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    input,button{margin:5px;padding:8px;border-radius:4px;border:1px solid #ccc}
    button{cursor:pointer;background:#333;color:#fff}
    .hidden{display:none}
    #historial div,#fuelList div{padding:5px;border-bottom:1px solid #ddd}
  </style>
</head>
<body>
  <header>
    <h1>ðŸš– Sigra - Gestor de Conductores</h1>
  </header>
  <main>
    <!-- Login/Registro -->
    <section id="authWrap">
      <h2>Login</h2>
      <input id="loginEmail" placeholder="Correo"><br>
      <input id="loginPass" type="password" placeholder="ContraseÃ±a"><br>
      <button onclick="login()">Ingresar</button>

      <h2>Registro</h2>
      <input id="regName" placeholder="Nombre"><br>
      <input id="regLast" placeholder="Apellido"><br>
      <input id="regEmail" placeholder="Correo"><br>
      <input id="regPass" type="password" placeholder="ContraseÃ±a"><br>
      <button onclick="register()">Registrar</button>
    </section>

    <!-- App -->
    <section id="appWrap" class="hidden">
      <h2>Bienvenido: <span id="currentUserLabel"></span></h2>
      <button onclick="logout()">Cerrar sesiÃ³n</button>

      <!-- Registrar carrera -->
      <h3>Registrar carrera</h3>
      <input id="dist" type="number" placeholder="Distancia (km)">
      <input id="tarifa" type="number" placeholder="Tarifa por km">
      <button onclick="addTrip()">Registrar</button>

      <!-- Historial -->
      <h3>Historial</h3>
      <div id="historial"></div>

      <!-- Totales -->
      <h3>Totales</h3>
      <div id="totales"></div>

      <!-- Precios de combustible -->
      <h3>Precios de Combustible</h3>
      <div id="fuelSection">
        <input id="price95" type="number" placeholder="Gasolina 95">
        <input id="price90" type="number" placeholder="Gasolina 90">
        <input id="pricediesel" type="number" placeholder="DiÃ©sel">
        <button onclick="saveFuelPrice()">Guardar Precio</button>
        <div id="fuelList"></div>
      </div>
    </section>
  </main>

<script>
const USERS_KEY="sigra_users";
const TRIPS_KEY="sigra_trips_";
const FUEL_KEY="sigra_fuel_";

let currentRole="conductor";

// Utilidades
function readJSON(k){return JSON.parse(localStorage.getItem(k)||"[]")}
function writeJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}
function hashPass(p){return btoa(p)} // no es seguro pero sirve para demo
function getTripKey(email){return TRIPS_KEY+email}
function getFuelKey(email){return FUEL_KEY+email}

// Registro
function register(){
  const name=document.getElementById('regName').value.trim();
  const last=document.getElementById('regLast').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value.trim();
  if(!name||!last||!email||!pass){alert("Completa todos los campos");return}
  const users=readJSON(USERS_KEY);
  if(users.find(u=>u.email===email)){alert("Correo ya registrado");return}
  const role = users.length===0 ? "admin" : "conductor";
  users.push({name,last,email,password:hashPass(pass),role,created:new Date().toISOString()});
  writeJSON(USERS_KEY,users);
  alert("Usuario registrado. Rol asignado: "+role);
}

// Login
function login(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const users=readJSON(USERS_KEY);
  const u=users.find(x=>x.email===email && x.password===hashPass(pass));
  if(!u){alert("Credenciales incorrectas");return}
  localStorage.setItem('sigra_current',email);
  showAppForUser(email);
}

function showAppForUser(email){
  document.getElementById('authWrap').style.display='none';
  document.getElementById('appWrap').style.display='block';
  const users=readJSON(USERS_KEY);
  const u=users.find(x=>x.email===email);
  currentRole=u?.role||"conductor";
  document.getElementById('currentUserLabel').innerText = `${email} (${currentRole})`;
  loadHistorial();
  loadTotals();
  loadFuelPrices();
  toggleFuelSection();
}

function logout(){
  localStorage.removeItem('sigra_current');
  document.getElementById('appWrap').style.display='none';
  document.getElementById('authWrap').style.display='block';
}

// Registrar carrera
function addTrip(){
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
  if(!dist||!tarifa){alert("Completa los datos");return}
  const email=localStorage.getItem('sigra_current');
  const key=getTripKey(email);
  const arr=readJSON(key);
  const ingreso=dist*tarifa;
  arr.push({fecha:new Date().toISOString(),dist,tarifa,ingreso});
  writeJSON(key,arr);
  document.getElementById('dist').value='';
  document.getElementById('tarifa').value='';
  loadHistorial();loadTotals();
}

function loadHistorial(){
  const email=localStorage.getItem('sigra_current');
  const arr=readJSON(getTripKey(email));
  const div=document.getElementById('historial');
  div.innerHTML='';
  arr.forEach(t=>{
    div.innerHTML+=`<div>${t.fecha}: ${t.dist} km x ${t.tarifa} = ${t.ingreso}</div>`;
  });
}

function loadTotals(){
  const email=localStorage.getItem('sigra_current');
  const arr=readJSON(getTripKey(email));
  let total=0;arr.forEach(t=>total+=t.ingreso);
  document.getElementById('totales').innerText="Total ingresos: "+total;
}

// Combustible
function saveFuelPrice(){
  if(currentRole!=="admin"){alert("Solo el admin puede guardar precios de combustible.");return}
  const email=localStorage.getItem('sigra_current');
  const p95=parseFloat(document.getElementById('price95').value)||0;
  const p90=parseFloat(document.getElementById('price90').value)||0;
  const pd=parseFloat(document.getElementById('pricediesel').value)||0;
  if(!p95&&!p90&&!pd){alert("Ingresa al menos un precio");return}
  const key=getFuelKey(email);
  const arr=readJSON(key);
  arr.push({fecha:new Date().toISOString(),g95:p95,g90:p90,diesel:pd});
  writeJSON(key,arr);
  document.getElementById('price95').value='';
  document.getElementById('price90').value='';
  document.getElementById('pricediesel').value='';
  loadFuelPrices();
  alert("Precio guardado âœ…");
}

function loadFuelPrices(){
  const email=localStorage.getItem('sigra_current');
  const arr=readJSON(getFuelKey(email));
  const div=document.getElementById('fuelList');
  div.innerHTML='';
  arr.forEach(f=>{
    div.innerHTML+=`<div>${f.fecha}: G95=${f.g95}, G90=${f.g90}, Diesel=${f.diesel}</div>`;
  });
}

function toggleFuelSection(){
  const fuelBlock=document.getElementById("fuelSection");
  if(currentRole!=="admin"){
    fuelBlock.querySelectorAll("input,button").forEach(el=>el.disabled=true);
  }else{
    fuelBlock.querySelectorAll("input,button").forEach(el=>el.disabled=false);
  }
}

// Auto login si hay sesiÃ³n
window.onload=function(){
  const email=localStorage.getItem('sigra_current');
  if(email){showAppForUser(email)}
}
</script>
</body>
</html>
