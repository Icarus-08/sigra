<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGRA - Gestor de Conductor ðŸš–</title>
  <style>
    :root {
      --primary:#007bff;
      --secondary:#6c757d;
      --bg:#f4f4f9;
      --card-bg:#fff;
    }
    body{margin:0;font-family:'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:#333;}
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:black;color:var(--primary);font-size:3rem;letter-spacing:.5rem;z-index:30;}
    .sigra span{opacity:0;animation:fadeInLetter 0.5s forwards;}
    .sigra span:nth-child(1){animation-delay:0.5s;}
    .sigra span:nth-child(2){animation-delay:1s;}
    .sigra span:nth-child(3){animation-delay:1.3s;}
    .sigra span:nth-child(4){animation-delay:1.5s;}
    .sigra span:nth-child(5){animation-delay:1.8s;}
    @keyframes fadeInLetter{from{opacity:0;filter:blur(4px);}to{opacity:1;filter:blur(0);}}
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;}
    .card{width:100%;max-width:920px;background:var(--card-bg);padding:1.25rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.12);}
    .hidden{display:none;}
    h1,h2,h3{margin:.25rem 0;}
    .row{display:flex;gap:12px;}
    .col{flex:1;}
    input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px;}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;}
    button.secondary{background:var(--secondary);}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .small{font-size:.9rem;color:#555;}
    .muted{color:#666;}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:12px;}
    .list{max-height:260px;overflow:auto;padding:8px;background:#fafafa;border-radius:8px;}
    table{width:100%;border-collapse:collapse;}
    table td,table th{padding:6px;border-bottom:1px solid #eee;}
    .actions{display:flex;gap:8px;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:var(--primary);font-weight:600;}
    footer{margin-top:12px;text-align:center;color:#666;font-size:.85rem;}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .2s;z-index:50;}
    .modal.show{visibility:visible;opacity:1;}
    .modal .content{background:var(--card-bg);padding:1rem;border-radius:10px;max-width:720px;max-height:80vh;overflow:auto;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="sigra">
      <span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span>
    </div>
  </div>

  <!-- Auth -->
  <div class="center-wrap" id="authWrap">
    <div class="card" id="loginCard">
      <h1 style="color:var(--primary)">SIGRA</h1>
      <div id="loginView">
        <input id="loginEmail" type="email" placeholder="Correo"/>
        <input id="loginPass" type="password" placeholder="ContraseÃ±a"/>
        <div class="row">
          <button onclick="doLogin()">Entrar</button>
          <button class="secondary" onclick="showRegister()">Crear Cuenta</button>
        </div>
        <p class="small muted">Al continuar aceptas nuestros 
          <a href="#" onclick="openTerms(event)">TÃ©rminos y Condiciones</a></p>
      </div>
    </div>
  </div>

  <!-- App -->
  <div style="display:none;padding:18px" id="appWrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h2 style="margin:0">Gestor de Conductor ðŸš–</h2>
          <div class="small">Usuario: <span id="currentUserLabel" class="pill">-</span></div>
        </div>
        <div class="actions">
          <button class="secondary" onclick="doLogout()">Cerrar SesiÃ³n</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <h3>Totales acumulados</h3>
          <div id="totales" class="list"></div>
          <h3>GrÃ¡fico (Ganancia vs Gastos)</h3>
          <canvas id="grafico" style="max-width:100%;height:240px;background:#fff;padding:8px;border-radius:8px"></canvas>
          <div style="margin-top:12px">
            <button id="btnPDF" onclick="exportPDF()">Exportar PDF</button>
          </div>
        </div>
      </div>
      <footer>SIGRA â€¢ LocalStorage â€¢ Desarrollo local</footer>
    </div>
  </div>

  <script>
    const CARRERAS_KEY='sigra_carreras';

    function loadTotals(){
      const arr=JSON.parse(localStorage.getItem(CARRERAS_KEY))||[];
      const totales=arr.reduce((acc,v)=>{
        acc.ganancia+=v.neto||0;
        acc.gastos+= (v.gasolinaFija||0)+(v.gasolina||0)+(v.pagoCarro||0)+(v.mantenimiento||0)+(v.otros||0);
        return acc;
      },{ganancia:0,gastos:0});
      document.getElementById('totales').innerHTML=
        `<div>Ganancia: $${totales.ganancia.toFixed(2)}</div>
         <div>Gastos: $${totales.gastos.toFixed(2)}</div>`;
      return totales;
    }

    function renderChart(){
      const ctx=document.getElementById('grafico').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      const data=loadTotals();
      window.myChart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ganancia','Gastos'],
          datasets:[{
            data:[data.ganancia,data.gastos],
            backgroundColor:['green','red']
          }]
        },
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }

    async function exportPDF(){
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF();
      doc.setFontSize(18);
      doc.text("Reporte Financiero - SIGRA",14,20);

      // Tabla
      const data=loadTotals();
      doc.autoTable({
        startY:30,
        head:[['Concepto','Monto']],
        body:[
          ['Ganancia',`$${data.ganancia.toFixed(2)}`],
          ['Gastos',`$${data.gastos.toFixed(2)}`]
        ]
      });

      // Capturar grÃ¡fico
      const canvas=document.getElementById("grafico");
      const imgData=canvas.toDataURL("image/png");
      doc.addImage(imgData,'PNG',15,doc.lastAutoTable.finalY+10,180,80);

      doc.save("Reporte_SIGRA.pdf");
    }

    window.addEventListener('load',()=>{
      setTimeout(()=>{
        document.getElementById('splash').style.opacity=0;
        setTimeout(()=>{
          document.getElementById('splash').style.display='none';
          document.getElementById('appWrap').style.display='block';
          loadTotals();
          renderChart();
        },500)
      },1500)
    })
  </script>
</body>
</html>
