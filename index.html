<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Carreras</title>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.6.1/firebase-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.6.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Agrega aquí tus estilos CSS */
  </style>
</head>
<body>
  <!-- Contenido de tu aplicación aquí -->

  <script>
    // Configuración de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCl55k6nUohSTnkcJvzc01ZtlIrgy7qIpI",
  authDomain: "sigra-b1d1b.firebaseapp.com",
  projectId: "sigra-b1d1b",
  storageBucket: "sigra-b1d1b.firebasestorage.app",
  messagingSenderId: "sigra-b1d1b.firebasestorage.app",
  appId: "1:171804390742:web:d4f73b2ce921fd8bc252f7"
};
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "hiroemiya1412@gmail.com";

    // Función para guardar precios de combustible
    async function saveFuelPrice() {
      const user = auth.currentUser;
      if (!user || user.email !== ADMIN_EMAIL) {
        alert('Solo el administrador puede guardar precios');
        return;
      }
      const p95 = parseFloat(document.getElementById('price95').value) || 0;
      const p90 = parseFloat(document.getElementById('price90').value) || 0;
      const pd = parseFloat(document.getElementById('pricediesel').value) || 0;
      if (!p95 && !p90 && !pd) {
        alert('Ingresa algún valor');
        return;
      }
      await db.collection('fuel_prices').add({ p95, p90, pd, date: new Date().toISOString() });
      document.getElementById('price95').value = '';
      document.getElementById('price90').value = '';
      document.getElementById('pricediesel').value = '';
      loadFuelPrices();
      alert('Precio guardado');
    }

    // Función para cargar los precios de combustible
    async function loadFuelPrices() {
      const snapshot = await db.collection('fuel_prices').orderBy('date', 'desc').limit(10).get();
      const el = document.getElementById('fuelList');
      el.innerHTML = '';
      if (snapshot.empty) {
        document.getElementById('lastFuel').innerText = '-';
        return;
      }
      snapshot.forEach((doc, i) => {
        const f = doc.data();
        const d = new Date(f.date);
        const row = document.createElement('div');
        row.innerText = `${d.toLocaleDateString()} — 95:$${f.p95} • 90:$${f.p90} • D:$${f.pd}`;
        el.appendChild(row);
        if (i === 0) {
          document.getElementById('lastFuel').innerText = `95:${f.p95} 90:${f.p90} D:${f.pd}`;
        }
      });
    }

    // Función para calcular la ganancia estimada
    function calcular() {
      const tarifa = parseFloat(document.getElementById('tarifa').value) || 0;
      const tiempo = parseFloat(document.getElementById('tiempo').value) || 0;
      const gasolina = parseFloat(document.getElementById('gasolina').value) || 0;
      const carro = parseFloat(document.getElementById('carro').value) || 0;
      const mantenimiento = parseFloat(document.getElementById('mantenimiento').value) || 0;
      const otros = parseFloat(document.getElementById('otros').value) || 0;
      const neto = (tarifa * tiempo) - (gasolina + carro + mantenimiento + otros);
      document.getElementById('resultado').innerText = 'Ganancia estimada: $' + neto.toFixed(2);
    }

    // Función para renderizar el gráfico
    async function renderChart() {
      const ctx = document.getElementById('grafico').getContext('2d');
      const user = auth.currentUser;
      if (!user) return;
      const snapshot = await db.collection('carreras').where('uid', '==', user.uid).orderBy('date', 'desc').limit(10).get();
      const labels = [];
      const neto = [];
      const gastos = [];
      snapshot.docs.reverse().forEach(doc => {
        const c = doc.data();
        labels.push(new Date(c.date).toLocaleDateString());
        neto.push(c.neto);
        gastos.push(c.gasolina + c.carro + c.mantenimiento + c.otros);
      });
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Neto', data: neto, backgroundColor: 'var(--primary)' },
            { label: 'Gastos', data: gastos, backgroundColor: '#6c757d' }
          ]
        },
        options: { responsive: true }
      });
    }

    // Función para exportar los datos a PDF
    async function exportPDF() {
      const user = auth.currentUser;
      if (!user) return;
      const snapshot = await db.collection('carreras').where('uid', '==', user.uid).orderBy('date', 'desc').get();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const rows = snapshot.docs.map(doc => {
        const c = doc.data();
        return [new Date(c.date).toLocaleDateString(), c.tarifa, c.tiempo, c.gasolina, c.carro, c.mantenimiento, c.otros, c.neto];
      });
      doc.autoTable({ head: [['Fecha', 'Tarifa', 'Tiempo', 'Gasolina', 'Carro', 'Mantenimiento', 'Otros', 'Neto']], body: rows });
      doc.save('historial.pdf');
    }

    // Función para cargar el historial de carreras
    async function loadHistorial() {
      const user = auth.currentUser;
      if (!user) return;
      const snapshot = await db.collection('carreras').where('uid', '==', user.uid).orderBy('date', 'desc').get();
      const el = document.getElementById('historialList');
      el.innerHTML = '';
      snapshot.forEach(doc => {
        const c = doc.data();
        const d = new Date(c.date);
        const row = document.createElement('div');
        row.innerText = `${d.toLocaleDateString()} — Neto: $${c.neto.toFixed(2)}`;
        el.appendChild(row);
      });
    }

    // Función para guardar una nueva carrera
    async function guardarCarrera() {
      const user = auth.currentUser;
      if (!user) {
        alert('Debes iniciar sesión');
        return;
      }
      const tarifa = parseFloat(document.getElementById('tarifa').value) || 0;
      const tiempo = parseFloat(document.getElementById('tiempo').value) || 0;
      const gasolina = parseFloat(document.getElementById('gasolina').value) || 0;
      const carro = parseFloat(document.getElementById('carro').value) || 0;
      const mantenimiento = parseFloat(document.getElementById('mantenimiento').value) || 0;
      const otros = parseFloat(document.getElementById('otros').value) || 0;
      const neto = (tarifa * tiempo) - (gasolina + carro + mantenimiento + otros);
      await db.collection('carreras').add({
        uid: user.uid,
        email: user.email,
        tarifa,
        tiempo,
        gasolina,
        carro,
        mantenimiento,
        otros,
        neto,
        date: new Date().toISOString()
      });
      alert('Carrera guardada');
      loadHistorial();
      renderChart();
    }

    // Función para iniciar sesión
    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        const uid = userCredential.user.uid;
        showAppForUser(uid);
      } catch (e) {
        alert('Correo o contraseña incorrectos');
      }
    }

    // Función para mostrar la aplicación para un usuario
    async function showAppForUser(uid) {
      document.getElementById('authWrap').style.display = 'none';
      document.getElementById('appWrap').style.display = 'block';
      const doc = await db.collection('users').doc(uid).get();
      const data = doc.data();
      document.getElementById('currentUserLabel').innerText = data.name + " " + data.last;
      if (!data.isAdmin) {
        document.getElementById('fuelInputs').style.display = 'none';
      }
      loadFuelPrices();
      loadHistorial();
      renderChart();
    }

    // Función para cerrar sesión
    function doLogout() {
      auth.signOut();
      location.reload();
    }
  </script>
</body>
</html>


