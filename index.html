<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRA - Gestor de Conductor ðŸš–</title>
<style>
  :root{--primary:#007bff;--bg:#f4f4f9;--card-bg:#fff}
  body{margin:0;font-family:'Segoe UI',Roboto,Arial,sans-serif;background:black;color:#333}
  .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
  .card{width:100%;max-width:920px;background:var(--card-bg);padding:1.25rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.12)}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button.secondary{background:#6c757d}
  .hidden{display:none}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .small{font-size:.9rem;color:#555}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:var(--primary);font-weight:600}
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- LOGIN / REGISTER -->
<div class="center-wrap" id="authWrap">
  <div class="card">
    <h1 style="color:var(--primary)">SIGRA</h1>

    <div id="loginView">
      <input id="loginEmail" type="email" placeholder="Correo" />
      <input id="loginPass" type="password" placeholder="ContraseÃ±a" />
      <div class="row">
        <button onclick="doLogin()">Entrar</button>
        <button class="secondary" onclick="showRegister()">Crear Cuenta</button>
      </div>
    </div>

    <div id="registerView" class="hidden">
      <h2>Crear Cuenta</h2>
      <input id="regName" placeholder="Nombre" />
      <input id="regEmail" type="email" placeholder="Correo" />
      <input id="regPass" type="password" placeholder="ContraseÃ±a" />
      <input id="regPass2" type="password" placeholder="Confirmar ContraseÃ±a" />
      <div class="row">
        <button onclick="createAccount()">Crear</button>
        <button class="secondary" onclick="showLogin()">Volver</button>
      </div>
    </div>

  </div>
</div>

<!-- APP -->
<div style="display:none;padding:18px" id="appWrap">
  <div class="card">
    <h2>Usuario: <span id="currentUserLabel" class="pill">-</span></h2>

    <!-- Precios Combustible -->
    <div id="fuelSection">
      <h3>Precios de Combustible</h3>
      <div id="fuelInputs" class="row">
        <input id="price95" placeholder="Gasolina 95 $" />
        <input id="price90" placeholder="Gasolina 90 $" />
        <input id="pricediesel" placeholder="DiÃ©sel $" />
        <button onclick="saveFuelPrice()">Guardar precio</button>
      </div>
      <div style="margin-top:8px" class="small">
        Ãšltimo precio guardado: <span id="lastFuel" class="pill">-</span>
      </div>
      <div id="fuelList" class="list"></div>
    </div>

    <!-- Carrera -->
    <div>
      <h3>Calcular Ganancia</h3>
      <input id="tarifa" placeholder="Tarifa (ganancia) $" />
      <input id="tiempo" placeholder="Tiempo (h)" />
      <input id="gasolina" placeholder="Gasolina $" />
      <input id="carro" placeholder="Gastos carro $" />
      <input id="mantenimiento" placeholder="Mantenimiento $" />
      <input id="otros" placeholder="Otros gastos $" />
      <button onclick="guardarCarrera()">Guardar Carrera</button>
      <div id="resultado"></div>
    </div>

    <!-- Historial -->
    <h3>Historial de Carreras</h3>
    <div id="historialList" class="list"></div>
    <div id="totales"></div>

    <canvas id="grafico" style="max-width:100%;height:240px"></canvas>

    <button class="secondary" onclick="doLogout()">Cerrar SesiÃ³n</button>
  </div>
</div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCl55k6nUohSTnkc01ZtlIrgy7qIpI",
    authDomain: "sigra-b1d1b.firebaseapp.com",
    projectId: "sigra-b1d1b",
    storageBucket: "sigra-b1d1b.appspot.com",
    messagingSenderId: "171804390742",
    appId: "1:171804390742:web:d4f73b2ce921fd8bc252f7",
    measurementId: "G-TXGV25GJRE"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  function showRegister(){document.getElementById('loginView').classList.add('hidden');document.getElementById('registerView').classList.remove('hidden')}
  function showLogin(){document.getElementById('registerView').classList.add('hidden');document.getElementById('loginView').classList.remove('hidden')}

  async function createAccount(){
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    const pass2 = document.getElementById('regPass2').value;
    const name = document.getElementById('regName').value.trim();
    if(!name||!email||!pass){alert('Completa todos los campos'); return;}
    if(pass!==pass2){alert('ContraseÃ±as no coinciden'); return;}
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    const uid = userCredential.user.uid;
    const isAdmin = (email === "hiroemiya1412@gmail.com"); 
    await db.collection('users').doc(uid).set({name,email,isAdmin});
    alert('Cuenta creada');
    showLogin();
  }

  async function doLogin(){
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    const userCredential = await auth.signInWithEmailAndPassword(email, pass);
    const uid = userCredential.user.uid;
    showAppForUser(uid,email);
  }

  function doLogout(){auth.signOut(); location.reload();}

  async function showAppForUser(uid,email){
    document.getElementById('authWrap').style.display='none';
    document.getElementById('appWrap').style.display='block';
    document.getElementById('currentUserLabel').innerText = email;

    const userDoc = await db.collection('users').doc(uid).get();
    const isAdmin = userDoc.data().isAdmin;

    // Solo ocultar inputs de admin
    if(!isAdmin){document.getElementById('fuelInputs').querySelectorAll('input, button').forEach(el=>el.style.display='none');}

    await loadHistorial();
    await loadFuelPrices();
    renderChart();
  }

  async function saveFuelPrice(){
    const uid = auth.currentUser.uid;
    const userDoc = await db.collection('users').doc(uid).get();
    if(!userDoc.data().isAdmin){alert('Solo el administrador puede guardar precios'); return;}
    const p95 = parseFloat(document.getElementById('price95').value) || 0;
    const p90 = parseFloat(document.getElementById('price90').value) || 0;
    const pd = parseFloat(document.getElementById('pricediesel').value) || 0;
    await db.collection('fuel_prices').add({fecha:new Date().toISOString(),g95:p95,g90:p90,diesel:pd});
    alert('Precio guardado');
    loadFuelPrices();
  }

  async function loadFuelPrices(){
    const snapshot = await db.collection('fuel_prices').orderBy('fecha','desc').limit(10).get();
    const el = document.getElementById('fuelList');
    el.innerHTML='';
    if(snapshot.empty){
      el.innerHTML='<div class="small muted">No hay precios guardados</div>';
      document.getElementById('lastFuel').innerText='-';
      return;
    }
    snapshot.forEach(doc=>{
      const f = doc.data();
      const d = new Date(f.fecha);
      el.innerHTML += `<div><strong>${d.toLocaleDateString()}</strong> â€” 95: ${f.g95||'-'} â€¢ 90: ${f.g90||'-'} â€¢ DiÃ©sel: ${f.diesel||'-'}</div>`;
    });
    const last = snapshot.docs[0].data();
    document.getElementById('lastFuel').innerText = `95:${last.g95||'-'} 90:${last.g90||'-'} D:${last.diesel||'-'}`;
  }

  // Carreras
  async function guardarCarrera(){
    const uid = auth.currentUser.uid;
    const email = auth.currentUser.email;
    const tarifa = parseFloat(document.getElementById('tarifa').value)||0;
    const tiempo = parseFloat(document.getElementById('tiempo').value)||0;
    const gasolina = parseFloat(document.getElementById('gasolina').value)||0;
    const carro = parseFloat(document.getElementById('carro').value)||0;
    const mantenimiento = parseFloat(document.getElementById('mantenimiento').value)||0;
    const otros = parseFloat(document.getElementById('otros').value)||0;
    const neto = (tarifa*tiempo)-(gasolina+carro+mantenimiento+otros);
    await db.collection('carreras').add({email,fecha:new Date().toISOString(),tarifa,tiempo,gasolina,carro,mantenimiento,otros,neto});
    alert('Carrera guardada');
    loadHistorial();
    renderChart();
  }

  async function loadHistorial(){
    const snapshot = await db.collection('carreras').orderBy('fecha','desc').get();
    const el = document.getElementById('historialList');
    el.innerHTML='';
    const email = auth.currentUser.email;
    const userData = snapshot.docs.filter(d=>d.data().email===email);
    if(!userData.length){el.innerHTML='<div class="small muted">No hay carreras</div>';return;}
    let totales = {neto:0,gasolina:0,carro:0,mantenimiento:0,otros:0};
    userData.forEach(doc=>{
      const c = doc.data();
      const d = new Date(c.fecha);
      el.innerHTML += `<div>${d.toLocaleDateString()} â€” Neto: $${c.neto.toFixed(2)}</div>`;
      totales.neto += c.neto; totales.gasolina+=c.gasolina; totales.carro+=c.carro;
      totales.mantenimiento+=c.mantenimiento; totales.otros+=c.otros;
    });
    document.getElementById('totales').innerHTML = `<div>Neto: $${totales.neto.toFixed(2)}</div>
    <div>Gasolina: $${totales.gasolina.toFixed(2)}</div>
    <div>Carro: $${totales.carro.toFixed(2)}</div>
    <div>Mantenimiento: $${totales.mantenimiento.toFixed(2)}</div>
    <div>Otros: $${totales.otros.toFixed(2)}</div>`;
  }

  async function renderChart(){
    const ctx=document.getElementById('grafico').getContext('2d');
    const snapshot = await db.collection('carreras').orderBy('fecha','desc').get();
    const email = auth.currentUser.email;
    const data = snapshot.docs.filter(d=>d.data().email===email).slice(0,10);
    const labels = data.map(d=>new Date(d.data().fecha).toLocaleDateString()).reverse();
    const neto = data.map(d=>d.data().neto).reverse();
    const gastos = data.map(d=>d.data().gasolina+d.data().carro+d.data().mantenimiento+d.data().otros).reverse();
    new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Neto',data:neto,backgroundColor:'var(--primary)'},{label:'Gastos',data:gastos,backgroundColor:'#6c757d'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}});
  }
</script>
</body>
</html>
