<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIGRA - Gestor de Conductor ðŸš–</title>

  <!-- Fonts / CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#00ffa6; --secondary:#00b7ff; --bg:#0d1117; --card-bg:#161b22;
      --input-bg:#0d1117; --list-bg:#0d1117; --canvas-bg:#0d1117; --border-color:#222;
      --border-input:#333; --text-color:#e6e6e6; --text-muted:#888; --text-small:#aaa;
    }
    .light-theme{ --bg:#fff; --card-bg:#fff; --input-bg:#fff; --list-bg:#f8f9fa; --canvas-bg:#f8f9fa; --border-color:#ddd; --border-input:#ccc; --text-color:#333; --text-muted:#666; --text-small:#555; }

    body{ margin:0; font-family:'Cinzel',serif; background:var(--bg); color:var(--text-color); transition: background-color .3s, color .3s; }
    .splash{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; color:var(--primary); font-size:3rem; letter-spacing:.5rem; z-index:9999; }
    .sigra span{ opacity:0; animation:fadeInLetter 2.5s forwards; }
    @keyframes fadeInLetter{ from{opacity:0;filter:blur(4px)} to{opacity:1;filter:blur(0)} }

    .center-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem; }
    .card{ width:100%; max-width:920px; background:var(--card-bg); padding:1.25rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.5); border:1px solid var(--primary); }
    .hidden{display:none;}
    .row{display:flex; gap:12px;}
    input,select,textarea,button{ font-size:15px; }
    input,select,textarea{ width:100%; padding:10px; margin:6px 0; border-radius:8px; border:1px solid var(--border-input); background:var(--input-bg); color:var(--text-color); }
    button{ padding:10px; border-radius:8px; background:var(--primary); color:#0d1117; border:none; cursor:pointer; font-weight:700; }
    button.secondary{ background:var(--secondary); color:#0d1117; }

    .theme-toggle{ background:#333; color:#fff; border-radius:50%; width:45px; height:45px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid #555; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .small{ font-size:.9rem; color:var(--text-small); } .muted{ color:var(--text-muted); }

    .grid{ display:grid; grid-template-columns:1fr 340px; gap:12px; }
    .list{ max-height:260px; overflow:auto; padding:8px; background:var(--list-bg); border-radius:8px; border:1px solid var(--border-color); }
    footer{ margin-top:12px; text-align:center; color:var(--text-muted); font-size:.85rem; }

    canvas { width:100% !important; height:240px !important; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; visibility:hidden; opacity:0; transition:all .2s; z-index:2000; }
    .modal.show{ visibility:visible; opacity:1; }
    .modal .content{ background:var(--card-bg); padding:1rem; border-radius:10px; max-width:720px; max-height:80vh; overflow:auto; }
  </style>

  <!-- Chart.js and plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="sigra"><span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span></div>
  </div>

  <!-- AUTH -->
  <div class="center-wrap" id="authWrap">
    <div class="card" id="loginCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h1 style="color:var(--primary); margin:0">SIGRA</h1>
        <button class="theme-toggle" id="themeTopBtn" title="Cambiar tema">ðŸŒ™</button>
      </div>

      <div id="loginView">
        <input id="loginEmail" type="email" placeholder="Correo (Gmail)" />
        <input id="loginPass" type="password" placeholder="ContraseÃ±a" minlength="4" />
        <div class="row">
          <button id="btnLogin">Entrar</button>
          <button class="secondary" id="btnShowRegister">Crear Cuenta</button>
        </div>
        <p class="small muted">Al continuar aceptas nuestros <a href="#" id="linkTerms">TÃ©rminos y Condiciones</a></p>
      </div>

      <div id="registerView" class="hidden">
        <h2>Crear Cuenta</h2>
        <div class="row">
          <input id="regName" placeholder="Nombre" />
          <input id="regLast" placeholder="Apellido" />
        </div>
        <input id="regEmail" type="email" placeholder="Correo (Gmail)" />
        <input id="regPass" type="password" placeholder="ContraseÃ±a" minlength="4" />
        <input id="regPass2" type="password" placeholder="Confirmar ContraseÃ±a" minlength="4" />
        <div style="margin:8px 0">
          <input id="acceptTerms" type="checkbox" />
          <label for="acceptTerms">He leÃ­do y acepto los <a href="#" id="linkTerms2">TÃ©rminos y Condiciones</a></label>
        </div>
        <div class="row">
          <button id="btnCreate">Crear</button>
          <button class="secondary" id="btnBackLogin">Volver</button>
        </div>
      </div>

      <div style="margin-top:10px" class="small muted">Usuarios registrados (local): <span id="userCount">0</span></div>
    </div>
  </div>

  <!-- APP -->
  <div style="display:none; padding:18px" id="appWrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h2 style="margin:0">Gestor de Conductor ðŸš–</h2>
          <div class="small">Usuario: <span id="currentUserLabel" class="pill">-</span></div>
        </div>
        <div class="actions">
          <button class="secondary" id="btnSessions">Ver sesiones</button>
          <button class="secondary" id="btnLogout">Cerrar SesiÃ³n</button>
          <button class="theme-toggle" id="themeAppBtn">ðŸŒ™</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <h3>Calcular Ganancia</h3>
          <div class="row">
            <input id="tarifa" type="number" step="0.01" min="0" placeholder="Tarifa (ganancia) $" />
            <input id="tiempo" type="number" step="0.01" min="0" placeholder="Tiempo (h)" />
          </div>
          <div class="row">
            <input id="pagoCarro" type="number" step="0.01" min="0" placeholder="Pago carro $" />
            <input id="gasolina" type="number" step="0.01" min="0" placeholder="Gasolina (solo visual) $" />
          </div>
          <div class="row">
            <input id="mantenimiento" type="number" step="0.01" min="0" placeholder="Mantenimiento $" />
            <input id="otros" type="number" step="0.01" min="0" placeholder="Otros gastos $" />
          </div>
          <div class="row">
            <button id="btnCalcular">Calcular</button>
            <button class="secondary" id="btnGuardar">Guardar</button>
          </div>
          <div id="resultado" class="list" style="margin-top:8px"></div>

          <h3 style="margin-top:14px">Historial de Carreras</h3>
          <div id="historialList" class="list"></div>
          <div class="row" style="margin-top:8px">
            <button id="btnRefresh">Refrescar</button>
            <button class="secondary" id="btnPDF">Exportar PDF</button>
          </div>

          <h3 style="margin-top:14px">Precios de Combustible</h3>
          <div id="fuelList" class="list"></div>
        </div>

        <div>
          <h3>Totales acumulados</h3>
          <div id="totales" class="list"></div>

          <h3 style="margin-top:12px">GrÃ¡fico (gastos vs neto)</h3>
          <canvas id="grafico"></canvas>
        </div>
      </div>

      <footer>SIGRA â€¢ Firestore â€¢ Desarrollo local</footer>
    </div>
  </div>

  <!-- Sessions modal -->
  <div class="modal" id="sessionsModal"><div class="content">
    <h3>Historial de sesiones</h3>
    <div id="sessionsList" class="list"></div>
    <div style="text-align:center;margin-top:8px"><button id="closeSessionsBtn">Cerrar</button></div>
  </div></div>

  <!-- Terms modal -->
  <div class="modal" id="termsModal"><div class="content">
    <h3 style="color:var(--primary); text-align:center">TÃ‰RMINOS Y CONDICIONES</h3>
    <div class="terms-content">
      <!-- texto reducido para ejemplo -->
      <p>Al registrarte aceptas los tÃ©rminos...</p>
    </div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
      <button id="termsAcceptBtn">Aceptar</button>
      <button id="termsRejectBtn" class="secondary">Rechazar</button>
    </div>
  </div></div>

  <!-- Firebase + App logic (module) -->
  <script type="module">
  // ---------- Firebase imports ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ---------- Your Firebase config (replace if needed) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCl55k6nUohSTnkcJvzc01ZtlIrgy7qIpI",
    authDomain: "sigra-b1d1b.firebaseapp.com",
    projectId: "sigra-b1d1b",
    storageBucket: "sigra-b1d1b.firebasestorage.app",
    messagingSenderId: "171804390742",
    appId: "1:171804390742:web:d4f73b2ce921fd8bc252f7",
    measurementId: "G-TXGV25GJRE"
  };

  // ---------- Init ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Register Chart DataLabels plugin
  Chart.register(ChartDataLabels);

  // ---------- Constants / state ----------
  const PRECIOS_COMBUSTIBLE = { g95: 0.938, g90: 0.896, diesel: 0.845 };

  // ---------- Helper DOM ----------
  const $ = id => document.getElementById(id);

  // ---------- UI init ----------
  // Elements
  const authWrap = $('authWrap'), appWrap = $('appWrap'), splash = $('splash');
  const loginView = $('loginView'), registerView = $('registerView');
  const btnLogin = $('btnLogin'), btnShowRegister = $('btnShowRegister'), btnCreate = $('btnCreate'), btnBackLogin = $('btnBackLogin');
  const btnCalcular = $('btnCalcular'), btnGuardar = $('btnGuardar'), btnRefresh = $('btnRefresh'), btnPDF = $('btnPDF');
  const btnLogout = $('btnLogout'), btnSessions = $('btnSessions');
  const resultadoEl = $('resultado'), historialList = $('historialList'), fuelList = $('fuelList'), totalesEl = $('totales');
  const currentUserLabel = $('currentUserLabel'), userCountEl = $('userCount');
  const sessionsModal = $('sessionsModal'), sessionsList = $('sessionsList'), closeSessionsBtn = $('closeSessionsBtn');
  const termsModal = $('termsModal'), termsAcceptBtn = $('termsAcceptBtn'), termsRejectBtn = $('termsRejectBtn');

  // Theme buttons
  const themeTopBtn = $('themeTopBtn'), themeAppBtn = $('themeAppBtn');

  // Simple helpers
  function showLoginView(){ loginView.classList.remove('hidden'); registerView.classList.add('hidden'); }
  function showRegisterView(){ loginView.classList.add('hidden'); registerView.classList.remove('hidden'); }

  // Hide splash and show proper view
  function finishSplashAndInit(user){
    splash.style.display = 'none';
    if(user){
      openAppForUser(user);
    }else{
      authWrap.style.display = 'flex';
    }
  }

  // ---------- Theme ----------
  function loadTheme(){
    const t = localStorage.getItem('sigra_theme');
    if(t === 'light') document.body.classList.add('light-theme'), setThemeIcons('â˜€ï¸');
    else document.body.classList.remove('light-theme'), setThemeIcons('ðŸŒ™');
  }
  function toggleTheme(){
    document.body.classList.toggle('light-theme');
    const now = document.body.classList.contains('light-theme') ? 'light' : 'dark';
    localStorage.setItem('sigra_theme', now);
    setThemeIcons(now === 'light' ? 'â˜€ï¸' : 'ðŸŒ™');
  }
  function setThemeIcons(ch){ themeTopBtn.textContent = ch; themeAppBtn.textContent = ch; }

  themeTopBtn.addEventListener('click', toggleTheme);
  themeAppBtn.addEventListener('click', toggleTheme);

  // ---------- Auth actions (Firebase) ----------
  btnShowRegister.addEventListener('click', ()=>{ showRegisterView(); });
  btnBackLogin.addEventListener('click', ()=>{ showLoginView(); });

  btnCreate.addEventListener('click', async ()=>{
    const name = $('regName').value.trim();
    const last = $('regLast').value.trim();
    const email = $('regEmail').value.trim().toLowerCase();
    const pass = $('regPass').value;
    const pass2 = $('regPass2').value;

    if(!name || !last || !email || !pass){ alert('Completa todos los campos'); return; }
    if(!email.endsWith('@gmail.com')){ alert('Debe usar un correo @gmail.com'); return; }
    if(pass.length < 4){ alert('La contraseÃ±a debe tener al menos 4 caracteres'); return; }
    if(pass !== pass2){ alert('Las contraseÃ±as no coinciden'); return; }
    if(!$('acceptTerms').checked){ alert('Debes aceptar los tÃ©rminos'); return; }

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      // Optionally store profile in Firestore 'users' collection
      await addDoc(collection(db, 'users'), { uid: cred.user.uid, email, name, last, created: serverTimestamp() });
      alert('Cuenta creada. Ya puedes iniciar sesiÃ³n.');
      showLoginView();
    }catch(err){
      console.error(err);
      alert('Error crear cuenta: ' + (err.message || err));
    }
  });

  btnLogin.addEventListener('click', async ()=>{
    const email = $('loginEmail').value.trim().toLowerCase();
    const pass = $('loginPass').value;
    if(!email || !pass){ alert('Escribe correo y contraseÃ±a'); return; }
    try{
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      // record session in Firestore
      await addDoc(collection(db, 'sessions'), { uid: cred.user.uid, email: cred.user.email, date: serverTimestamp() });
      openAppForUser(cred.user);
    }catch(err){
      console.error(err);
      alert('Error login: ' + (err.message || err));
    }
  });

  btnLogout.addEventListener('click', async ()=>{
    try{ await signOut(auth); location.reload(); } catch(e){ console.error(e); alert('Error al cerrar sesiÃ³n'); }
  });

  // Listen for auth state changes (keeps UI in sync)
  onAuthStateChanged(auth, user => {
    if(user){
      // If the app is already visible, just update user label, otherwise finish splash -> open app
      if(appWrap.style.display === 'block') currentUserLabel.innerText = user.email;
      else finishSplashAndInit(user);
    } else {
      // no user logged
      if(splash.style.display !== 'none') {
        // let splash finish then show login
        setTimeout(()=>finishSplashAndInit(null), 1500);
      } else {
        authWrap.style.display = 'flex'; appWrap.style.display = 'none';
      }
    }
  });

  // ---------- Firestore helpers ----------
  async function saveCarreraToFirestore(carrera){
    // carrera is an object { uid, email, tarifa, gasolinaFija, gasolina, pagoCarro, mantenimiento, otros, neto, tiempo, date }
    try{
      await addDoc(collection(db,'carreras'), { ...carrera, created: serverTimestamp() });
      return true;
    }catch(e){
      console.error('saveCarrera', e);
      return false;
    }
  }

  async function fetchCarrerasForUser(uid){
    const q = query(collection(db,'carreras'), where('uid','==',uid), orderBy('created','desc'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  // ---------- Calculation UI ----------
  function getLastFuelPrice(){ return PRECIOS_COMBUSTIBLE.g95; }
  function loadFuelPricesUI(){
    fuelList.innerHTML = `
      <div>95: $${PRECIOS_COMBUSTIBLE.g95.toFixed(2)}</div>
      <div>90: $${PRECIOS_COMBUSTIBLE.g90.toFixed(2)}</div>
      <div>DiÃ©sel: $${PRECIOS_COMBUSTIBLE.diesel.toFixed(2)}</div>
    `;
  }

  btnCalcular.addEventListener('click', ()=>{
    const tarifa = parseFloat($('tarifa').value) || 0;
    const pagoCarro = parseFloat($('pagoCarro').value) || 0;
    const mantenimiento = parseFloat($('mantenimiento').value) || 0;
    const otros = parseFloat($('otros').value) || 0;
    // Gasolina is visual only
    const neto = tarifa - (pagoCarro + mantenimiento + otros);
    resultadoEl.innerText = `Ganancia estimada: $${neto.toFixed(2)}`;
  });

  // ---------- Save carrera ----------
  btnGuardar.addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('No estÃ¡s logueado'); return; }

    const tarifa = parseFloat($('tarifa').value) || 0;
    const gasolinaFija = getLastFuelPrice();
    const gasolina = parseFloat($('gasolina').value) || 0;
    const pagoCarro = parseFloat($('pagoCarro').value) || 0;
    const mantenimiento = parseFloat($('mantenimiento').value) || 0;
    const otros = parseFloat($('otros').value) || 0;
    const tiempo = parseFloat($('tiempo').value) || 0;

    // neto excludes gasoline (visual)
    const neto = tarifa - (pagoCarro + mantenimiento + otros);

    const carrera = {
      uid: user.uid,
      email: user.email,
      tarifa, gasolinaFija, gasolina, pagoCarro, mantenimiento, otros, neto, tiempo, date: new Date().toISOString()
    };

    const ok = await saveCarreraToFirestore(carrera);
    if(ok){
      alert('Guardado (Firestore)');
      await loadHistorialAndTotals(); renderChart();
    } else {
      alert('Error al guardar (ver consola)');
    }
  });

  // ---------- Load historial / totals ----------
  async function loadHistorialAndTotals(){
    const user = auth.currentUser;
    if(!user) return;
    historialList.innerHTML = '<div class="muted small">Cargando...</div>';
    const carreras = await fetchCarrerasForUser(user.uid);
    // render historial
    if(!carreras.length){ historialList.innerHTML = '<div class="small muted">No hay carreras</div>'; }
    else{
      historialList.innerHTML = '';
      carreras.forEach(c => {
        const d = new Date(c.created?.seconds ? c.created.seconds * 1000 : c.date || Date.now());
        const div = document.createElement('div');
        div.innerText = `${d.toLocaleDateString()} â€” Neto: $${(c.neto||0).toFixed(2)}`;
        historialList.appendChild(div);
      });
    }

    // totals
    const tot = carreras.reduce((acc,c)=>{
      acc.neto += (c.neto||0);
      acc.gasolina += ((c.gasolinaFija||0) + (c.gasolina||0));
      acc.carro += (c.pagoCarro||0);
      acc.mantenimiento += (c.mantenimiento||0);
      acc.otros += (c.otros||0);
      return acc;
    }, { neto:0, gasolina:0, carro:0, mantenimiento:0, otros:0 });

    totalesEl.innerHTML = `
      <div>Neto: $${tot.neto.toFixed(2)}</div>
      <div>Gasolina (visual): $${tot.gasolina.toFixed(2)}</div>
      <div>Pago carro: $${tot.carro.toFixed(2)}</div>
      <div>Mantenimiento: $${tot.mantenimiento.toFixed(2)}</div>
      <div>Otros: $${tot.otros.toFixed(2)}</div>
    `;

    return carreras;
  }

  btnRefresh.addEventListener('click', async ()=>{ await loadHistorialAndTotals(); renderChart(); });

  // ---------- Chart ----------
  let myChart = null;
  async function renderChart(){
    const user = auth.currentUser;
    if(!user) return;
    const carreras = await fetchCarrerasForUser(user.uid);
    const arr = carreras.slice(0,10).reverse(); // take most recent 10 and reverse to show oldest->newest
    const labels = arr.map(c => new Date(c.created?.seconds ? c.created.seconds*1000 : c.date).toLocaleDateString());
    const ganancia = arr.map(c => c.neto || 0);
    const gastos = arr.map(c => ( (c.gasolinaFija||0) + (c.gasolina||0) + (c.pagoCarro||0) + (c.mantenimiento||0) + (c.otros||0) ));

    const ctx = $('grafico').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Ganancia', data: ganancia, backgroundColor: 'rgba(0,200,102,0.8)' },
          { label: 'Gastos (visual)', data: gastos, backgroundColor: 'rgba(220,53,69,0.8)' }
        ]
      },
      options: {
        responsive:true,
        plugins: {
          legend:{ position:'top' },
          datalabels: { anchor:'end', align:'top', color:'#fff', font:{weight:'bold'}, formatter: v => `$${v.toFixed(2)}` }
        },
        scales: { y: { beginAtZero:true } }
      },
      plugins: [ChartDataLabels]
    });
  }

  // ---------- export PDF ----------
  btnPDF.addEventListener('click', exportPDF);
  async function exportPDF(){
    const user = auth.currentUser;
    if(!user){ alert('No estÃ¡s logueado'); return; }
    const carreras = await fetchCarrerasForUser(user.uid);
    if(!carreras.length){ alert('No hay carreras para exportar'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;

    // Colors
    const primaryColor = [41,128,185];
    const secondaryColor = [52,73,94];
    const accentColor = [231,76,60];

    // Header
    doc.setFillColor(...primaryColor);
    doc.rect(0,0,pageWidth,36,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(16);
    doc.text('HISTORIAL DE CARRERAS - SIGRA', 18, 22);

    // Info
    doc.setTextColor(...secondaryColor);
    doc.setFontSize(10);
    const now = new Date();
    doc.text(`Generado: ${now.toLocaleString()}`, 14, 46);
    doc.text(`Usuario: ${user.email}`, 14, 52);
    doc.text(`Total registros: ${carreras.length}`, 14, 58);

    // Table
    const tableData = carreras.map((c, i) => {
      const d = new Date(c.created?.seconds ? c.created.seconds*1000 : c.date || Date.now());
      return [
        (i+1).toString(),
        d.toLocaleDateString(),
        d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit'}),
        `$${(c.tarifa||0).toFixed(2)}`,
        `$${(((c.gasolinaFija||0) + (c.gasolina||0))).toFixed(2)}`,
        `$${(c.pagoCarro||0).toFixed(2)}`,
        `$${(c.mantenimiento||0).toFixed(2)}`,
        `$${(c.otros||0).toFixed(2)}`,
        `$${(c.neto||0).toFixed(2)}`
      ];
    });

    doc.autoTable({
      startY: 66,
      head: [['#','Fecha','Hora','Tarifa','Gasolina','Pago Carro','Mantenimiento','Otros','Neto']],
      body: tableData,
      styles: { fontSize:8 },
      headStyles: { fillColor: primaryColor, textColor: [255,255,255] },
      margin: { left: 12, right: 12 }
    });

    // Totals
    const lastY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 8 : 66;
    const totals = carreras.reduce((acc,c)=>{
      acc.tarifa += (c.tarifa||0);
      acc.gasolina += ((c.gasolinaFija||0) + (c.gasolina||0));
      acc.pagoCarro += (c.pagoCarro||0);
      acc.mantenimiento += (c.mantenimiento||0);
      acc.otros += (c.otros||0);
      acc.neto += (c.neto||0);
      return acc;
    }, { tarifa:0, gasolina:0, pagoCarro:0, mantenimiento:0, otros:0, neto:0 });

    doc.setFontSize(12);
    doc.setTextColor(...secondaryColor);
    doc.text('RESUMEN FINANCIERO', 14, lastY + 8);

    doc.autoTable({
      startY: lastY + 12,
      body: [
        ['Total Tarifas', `$${totals.tarifa.toFixed(2)}`],
        ['Total Gasolina (visual)', `$${totals.gasolina.toFixed(2)}`],
        ['Pago Carro', `$${totals.pagoCarro.toFixed(2)}`],
        ['Mantenimiento', `$${totals.mantenimiento.toFixed(2)}`],
        ['Otros', `$${totals.otros.toFixed(2)}`],
        ['GANANCIA NETA TOTAL', `$${totals.neto.toFixed(2)}`]
      ],
      theme:'plain',
      columnStyles: { 0:{ halign:'left', cellWidth:120 }, 1:{ halign:'right' } },
      margin:{ left:14, right:14 }
    });

    const fileName = `SIGRA_Historial_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fileName);
    console.log('PDF guardado', fileName);
  }

  // ---------- Sessions modal ----------
  btnSessions.addEventListener('click', async ()=>{
    sessionsModal.classList.add('show');
    // Fetch latest sessions from Firestore (simple query)
    try{
      const q = query(collection(db,'sessions'), orderBy('date','desc'));
      const snap = await getDocs(q);
      sessionsList.innerHTML = '';
      snap.docs.slice(0,30).forEach(d=>{
        const data = d.data();
        const dDate = data.date?.seconds ? new Date(data.date.seconds*1000) : new Date();
        const el = document.createElement('div');
        el.innerText = `${data.email || data.uid} â€” ${dDate.toLocaleString()}`;
        sessionsList.appendChild(el);
      });
      if(!sessionsList.children.length) sessionsList.innerHTML = '<div class="small muted">No hay sesiones</div>';
    }catch(e){ console.error(e); sessionsList.innerHTML = '<div class="small muted">Error cargando sesiones</div>'; }
  });
  closeSessionsBtn.addEventListener('click', ()=> sessionsModal.classList.remove('show'));

  // Terms modal handlers
  $('linkTerms').addEventListener('click', (e)=>{ e.preventDefault(); termsModal.classList.add('show'); });
  $('linkTerms2').addEventListener('click', (e)=>{ e.preventDefault(); termsModal.classList.add('show'); });
  termsAcceptBtn.addEventListener('click', ()=>{ $('acceptTerms').checked = true; termsModal.classList.remove('show'); });
  termsRejectBtn.addEventListener('click', ()=>{ $('acceptTerms').checked = false; termsModal.classList.remove('show'); });

  // ---------- Utilities ----------
  async function openAppForUser(user){
    authWrap.style.display = 'none';
    appWrap.style.display = 'block';
    currentUserLabel.innerText = user.email;
    loadFuelPricesUI();
    await loadHistorialAndTotals();
    await renderChart();
  }

  // Splash hide + theme init + userCount local (optional)
  window.addEventListener('load', ()=>{
    loadTheme();
    // remove splash after short delay (visual)
    setTimeout(()=>{ splash.style.opacity = 0; setTimeout(()=>{ splash.style.display = 'none'; }, 400) }, 1200);

    // show local userCount (number of users in localStorage 'users' collection) - not authoritative
    // For demo: count Firestore users is possible but requires getDocs; we avoid on load heavy operations.
    try{ const localUsers = JSON.parse(localStorage.getItem('sigra_users') || '[]'); userCountEl.innerText = Array.isArray(localUsers) ? localUsers.length : 0; }catch(e){ userCountEl.innerText = 0; }
  });

  </script>
</body>
</html>

