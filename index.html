<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGRA - Gestor de Conductor ðŸš–</title>
  <style>
    :root{--primary:#007bff;--bg:#f4f4f9;--card-bg:#fff}
    body{margin:0;font-family:'Segoe UI',Roboto,Arial,sans-serif;background:black;color:#333}
    /* Splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:black;color:var(--primary);font-size:3rem;letter-spacing:.5rem;z-index:30}
    .sigra span{opacity:0;animation:fadeInLetter 1s forwards}
    .sigra span:nth-child(1){animation-delay:.5s}
    .sigra span:nth-child(2){animation-delay:1s}
    .sigra span:nth-child(3){animation-delay:1.5s}
    .sigra span:nth-child(4){animation-delay:2s}
    .sigra span:nth-child(5){animation-delay:2.5s}
    @keyframes fadeInLetter{from{opacity:0;filter:blur(4px)}to{opacity:1;filter:blur(0)}}
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}
    /* Containers */
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .card{width:100%;max-width:920px;background:var(--card-bg);padding:1.25rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    .hidden{display:none}
    h1,h2,h3{margin:.25rem 0}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#6c757d}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small{font-size:.9rem;color:#555}
    .muted{color:#666}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:12px}
    .list{max-height:260px;overflow:auto;padding:8px;background:#fafafa;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    table td,table th{padding:6px;border-bottom:1px solid #eee}
    .actions{display:flex;gap:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:var(--primary);font-weight:600}
    footer{margin-top:12px;text-align:center;color:#666;font-size:.85rem}
    /* Responsive */
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .2s;z-index:50}
    .modal.show{visibility:visible;opacity:1}
    .modal .content{background:var(--card-bg);padding:1rem;border-radius:10px;max-width:720px;max-height:80vh;overflow:auto}
    /* Small helpers */
    .right{text-align:right}
  </style>
  <!-- LibrerÃ­as (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- SPLASH -->
  <div class="splash" id="splash">
    <div class="sigra"> <span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span> </div>
  </div>

  <!-- LOGIN / REGISTER -->
  <div class="center-wrap" id="authWrap">
    <div class="card" id="loginCard">
      <h1 style="color:var(--primary)">SIGRA</h1>
      <div id="loginView">
        <input id="loginEmail" type="email" placeholder="Correo" />
        <input id="loginPass" type="password" placeholder="ContraseÃ±a" />
        <div class="row">
          <button onclick="doLogin()">Entrar</button>
          <button class="secondary" onclick="showRegister()">Crear Cuenta</button>
        </div>
        <p class="small muted">Al continuar aceptas nuestros <a href="#" onclick="openTerms(event)">TÃ©rminos y Condiciones</a></p>
      </div>

      <div id="registerView" class="hidden">
        <h2>Crear Cuenta</h2>
        <div class="row">
          <input id="regName" placeholder="Nombre" />
          <input id="regLast" placeholder="Apellido" />
        </div>
        <input id="regEmail" type="email" placeholder="Correo" />
        <input id="regPass" type="password" placeholder="ContraseÃ±a" />
        <input id="regPass2" type="password" placeholder="Confirmar ContraseÃ±a" />
        <div style="margin:8px 0" class="terms-checkbox">
          <input id="acceptTerms" type="checkbox" /> <label for="acceptTerms">He leÃ­do y acepto los <a href="#" onclick="openTerms(event)">TÃ©rminos y Condiciones</a></label>
        </div>
        <div class="row">
          <button onclick="createAccount()">Crear</button>
          <button class="secondary" onclick="showLogin()">Volver</button>
        </div>
      </div>

      <div style="margin-top:10px" class="small muted">Usuarios registrados: <span id="userCount">0</span></div>
    </div>
  </div>

  <!-- MODAL TERMINOS -->
  <div class="modal" id="termsModal">
    <div class="content">
      <h2 style="color:var(--primary);text-align:center">TÃ©rminos y Condiciones</h2>
      <p><b>Confidencialidad de la InformaciÃ³n</b><br>Todos los datos suministrados por los usuarios se almacenan localmente en el navegador (localStorage). No se envÃ­a informaciÃ³n a servidores. Usa contraseÃ±as seguras. Esta aplicaciÃ³n es para uso local/educativo.</p>
      <div style="text-align:center;margin-top:12px"><button onclick="acceptTerms()">Aceptar</button> <button class="secondary" onclick="rejectTerms()">Rechazar</button></div>
    </div>
  </div>

  <!-- GESTOR PRINCIPAL -->
  <div style="display:none;padding:18px" id="appWrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h2 style="margin:0">Gestor de Conductor ðŸš–</h2>
          <div class="small">Usuario: <span id="currentUserLabel" class="pill">-</span></div>
        </div>
        <div class="actions">
          <button onclick="openSessions()" class="secondary">Ver sesiones</button>
          <button id="btnLogout" class="secondary" onclick="doLogout()">Cerrar SesiÃ³n</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <!-- CALCULO CARRERA -->
          <div style="margin-bottom:12px">
            <h3>Calcular Ganancia</h3>
            <div class="row">
              <input id="tarifa" placeholder="Tarifa (ganancia) $" />
              <input id="tiempo" placeholder="Tiempo (h)" />
            </div>
            <div class="row">
              <input id="gasolina" placeholder="Gasolina $ (usar Ãºltimo si vacÃ­o)" />
              <input id="carro" placeholder="Gastos carro $" />
            </div>
            <div class="row">
              <input id="mantenimiento" placeholder="Mantenimiento $" />
              <input id="otros" placeholder="Otros gastos $" />
            </div>
            <div class="row">
              <button onclick="calcular()">Calcular</button>
              <button class="secondary" onclick="guardarCarrera()">Guardar Carrera</button>
            </div>
            <div id="resultado" class="list" style="margin-top:8px"></div>
          </div>

          <!-- HISTORIAL CARRERAS -->
          <div style="margin-bottom:12px">
            <h3>Historial de Carreras</h3>
            <div id="historialList" class="list"></div>
            <div style="margin-top:8px" class="row">
              <button onclick="loadHistorial()">Refrescar</button>
              <button class="secondary" id="btnPDF" onclick="exportPDF()">Exportar PDF</button>
            </div>
          </div>

          <!-- PRECIOS COMBUSTIBLE -->
          <div>
            <h3>Precios de Combustible (por usuario)</h3>
            <div class="row">
              <input id="price95" placeholder="Gasolina 95 $" />
              <input id="price90" placeholder="Gasolina 90 $" />
            </div>
            <div class="row">
              <input id="pricediesel" placeholder="DiÃ©sel $" />
              <input id="btnSaveFuel" type="button" value="Guardar precio del dÃ­a" onclick="saveFuelPrice()" />
            </div>
            <div style="margin-top:8px" class="small muted">Ãšltimo precio guardado: <span id="lastFuel" class="pill">-</span></div>

            <h4 style="margin-top:8px">Historial de precios</h4>
            <div id="fuelList" class="list"></div>
          </div>
        </div>

        <div>
          <!-- TOTALES Y GRAFICO -->
          <div style="margin-bottom:12px">
            <h3>Totales acumulados</h3>
            <div id="totales" class="list"></div>
          </div>

          <div>
            <h3>GrÃ¡fico (gastos vs neto)</h3>
            <canvas id="grafico" style="max-width:100%;height:240px;background:#fff;padding:8px;border-radius:8px"></canvas>
          </div>
        </div>
      </div>

      <footer>SIGRA â€¢ LocalStorage â€¢ Desarrollo local</footer>
    </div>
  </div>

  <!-- MODAL SESSIONS -->
  <div class="modal" id="sessionsModal">
    <div class="content">
      <h3>Historial de sesiones</h3>
      <div id="sessionsList" class="list"></div>
      <div style="text-align:center;margin-top:8px"><button onclick="closeSessions()">Cerrar</button></div>
    </div>
  </div>

  <script>
    // --- Utils ---
    const USERS_KEY = 'sigra_users';
    const SESSIONS_KEY = 'sigra_sessions';
    const sanitizeEmailKey = (email)=>email.trim().toLowerCase();

    function readJSON(key){try{return JSON.parse(localStorage.getItem(key))||[]}catch(e){return []}}
    function writeJSON(key,val){localStorage.setItem(key,JSON.stringify(val))}

    // Simple 'hash' for passwords (base64) - not secure but avoids plain text
    function hashPass(p){return btoa(p)}

    // --- Auth UI ---
    function showRegister(){document.getElementById('loginView').classList.add('hidden');document.getElementById('registerView').classList.remove('hidden')}
    function showLogin(){document.getElementById('registerView').classList.add('hidden');document.getElementById('loginView').classList.remove('hidden')}

    function openTerms(e){e&&e.preventDefault();document.getElementById('termsModal').classList.add('show')}
    function acceptTerms(){document.getElementById('acceptTerms').checked=true;document.getElementById('termsModal').classList.remove('show')}
    function rejectTerms(){document.getElementById('acceptTerms').checked=false;document.getElementById('termsModal').classList.remove('show')}

    // --- Accounts ---
    function createAccount(){
      const name=document.getElementById('regName').value.trim();
      const last=document.getElementById('regLast').value.trim();
      const email=sanitizeEmailKey(document.getElementById('regEmail').value);
      const pass=document.getElementById('regPass').value;
      const pass2=document.getElementById('regPass2').value;
      const accepted=document.getElementById('acceptTerms').checked;
      if(!name||!last||!email||!pass){alert('Completa todos los campos');return}
      if(pass!==pass2){alert('Las contraseÃ±as no coinciden');return}
      if(!accepted){alert('Debes aceptar los tÃ©rminos');return}
      const users=readJSON(USERS_KEY);
      if(users.find(u=>u.email===email)){alert('Ya existe una cuenta con ese correo');return}
      users.push({name,last,email,password:hashPass(pass),created:new Date().toISOString()});
      writeJSON(USERS_KEY,users);
      document.getElementById('regName').value='';document.getElementById('regLast').value='';document.getElementById('regEmail').value='';document.getElementById('regPass').value='';document.getElementById('regPass2').value='';document.getElementById('acceptTerms').checked=false;
      alert('Cuenta creada. Ya puedes iniciar sesiÃ³n.');
      updateUserCount();
      showLogin();
    }

    function updateUserCount(){document.getElementById('userCount').innerText=readJSON(USERS_KEY).length}

    function doLogin(){
      const email=sanitizeEmailKey(document.getElementById('loginEmail').value);
      const pass=document.getElementById('loginPass').value;
      const users=readJSON(USERS_KEY);
      const u=users.find(x=>x.email===email);
      if(!u||u.password!==hashPass(pass)){alert('Correo o contraseÃ±a incorrectos');return}
      // set current session
      localStorage.setItem('sigra_current',email);
      recordSession(email);
      showAppForUser(email);
    }

    function recordSession(email){
      const sessions=readJSON(SESSIONS_KEY);
      sessions.push({email,date:new Date().toISOString()});
      writeJSON(SESSIONS_KEY,sessions);
    }

    function doLogout(){localStorage.removeItem('sigra_current');document.getElementById('appWrap').style.display='none';document.getElementById('authWrap').style.display='flex';document.getElementById('loginCard').classList.remove('hidden');document.getElementById('splash').style.display='none';}

    // Show sessions modal
    function openSessions(){const sessions=readJSON(SESSIONS_KEY).slice().reverse();const el=document.getElementById('sessionsList');el.innerHTML='';if(!sessions.length)el.innerHTML='<div class="small muted">No hay sesiones registradas</div>';
      sessions.forEach(s=>{const d=new Date(s.date);const row=document.createElement('div');row.style.padding='6px 0';row.innerHTML=`<strong>${s.email}</strong> â€” <span class="small muted">${d.toLocaleString()}</span>`;el.appendChild(row)})
      document.getElementById('sessionsModal').classList.add('show')}
    function closeSessions(){document.getElementById('sessionsModal').classList.remove('show')}

    // --- App / Gestor ---
    function showAppForUser(email){
      document.getElementById('authWrap').style.display='none';
      document.getElementById('appWrap').style.display='block';
      document.getElementById('currentUserLabel').innerText=email;
      loadHistorial();
      loadTotals();
      loadFuelPrices();
      renderChart();
    }

    // Historial de carreras por usuario
    function getHistKey(email){return `historial_${email}`}
    function getFuelKey(email){return `fuel_${email}`}

    let ultimoResultado=null;
    let listaCarreras=[];

    function calcular(){
      const email=localStorage.getItem('sigra_current');
      if(!email){alert('No estÃ¡s logueado');return}
      const tarifa=parseFloat(document.getElementById('tarifa').value)||0;
      let gasolina=parseFloat(document.getElementById('gasolina').value||0);
      const carro=parseFloat(document.getElementById('carro').value)||0;
      const mantenimiento=parseFloat(document.getElementById('mantenimiento').value)||0;
      const otros=parseFloat(document.getElementById('otros').value)||0;
      const tiempo=parseFloat(document.getElementById('tiempo').value)||0;
      // si gasolina vacÃ­o, tomar Ãºltimo precio y suponer consumo 1 unidad (usuario puede ajustar)
      if(!gasolina){
        const fuels=readJSON(getFuelKey(email));
        if(fuels.length){const last=fuels[fuels.length-1];gasolina=last.g95||last.g90||last.diesel||0}
      }
      if(tarifa===0||tiempo===0){alert('Por favor ingresa al menos la ganancia y el tiempo en horas');return}
      const totalGastos = gasolina + carro + mantenimiento + otros;
      const neto = tarifa - totalGastos;
      const resultadoEl = document.getElementById('resultado');
      resultadoEl.innerHTML = `\n        <p>ðŸ“Œ Tarifa: $${tarifa.toFixed(2)}</p>\n        <p>â›½ Gasolina: $${gasolina.toFixed(2)}</p>\n        <p>ðŸš— Carro: $${carro.toFixed(2)}</p>\n        <p>ðŸ”§ Mantenimiento: $${mantenimiento.toFixed(2)}</p>\n        <p>ðŸ§¾ Otros: $${otros.toFixed(2)}</p>\n        <p>âœ… Ganancia neta: $${neto.toFixed(2)} en ${tiempo} h</p>\n      `;
      ultimoResultado={tarifa,gasolina,carro,mantenimiento,otros,tiempo,neto,fecha:new Date().toISOString()};
    }

    function guardarCarrera(){
      const email=localStorage.getItem('sigra_current');
      if(!email){alert('No estÃ¡s logueado');return}
      if(!ultimoResultado){alert('Primero calcula una carrera antes de guardarla');return}
      const key=getHistKey(email);
      const historial=readJSON(key);
      historial.push(ultimoResultado);
      writeJSON(key,historial);
      ultimoResultado=null;document.getElementById('resultado').innerHTML='Guardado âœ…';
      loadHistorial();loadTotals();renderChart();
    }

    function loadHistorial(){
      const email=localStorage.getItem('sigra_current');
      if(!email) return;
      const key=getHistKey(email);
      const historial=readJSON(key);
      listaCarreras=historial.slice();
      const el=document.getElementById('historialList');el.innerHTML='';
      if(!historial.length){el.innerHTML='<div class="small muted">No hay carreras guardadas</div>'}
      historial.slice().reverse().forEach((c,i)=>{
        const d=new Date(c.fecha);
        const div=document.createElement('div');div.style.padding='6px 0';
        div.innerHTML=`<strong>${d.toLocaleString()}</strong> â€” Tarifa: $${c.tarifa.toFixed(2)} â€¢ Neto: $${c.neto.toFixed(2)}`;
        el.appendChild(div);
      })
      // mostrar/ocultar boton PDF si hay datos
      document.getElementById('btnPDF').style.display = historial.length? 'inline-block':'none';
    }

    function loadTotals(){
      const email=localStorage.getItem('sigra_current');if(!email)return;
      const historial=readJSON(getHistKey(email));
      const totalesEl=document.getElementById('totales');totalesEl.innerHTML='';
      if(!historial.length){totalesEl.innerHTML='<div class="small muted">Sin datos</div>';return}
      const totalTarifa=historial.reduce((s,c)=>s+c.tarifa,0);
      const totalGas=historial.reduce((s,c)=>s+c.gasolina,0);
      const totalCarro=historial.reduce((s,c)=>s+c.carro,0);
      const totalMant=historial.reduce((s,c)=>s+c.mantenimiento,0);
      const totalOtros=historial.reduce((s,c)=>s+c.otros,0);
      const totalNeto=historial.reduce((s,c)=>s+c.neto,0);
      totalesEl.innerHTML=`<p>ðŸ“ˆ Ganancia total: $${totalTarifa.toFixed(2)}</p>
        <p>â›½ Gasolina total: $${totalGas.toFixed(2)}</p>
        <p>ðŸš— Carro: $${totalCarro.toFixed(2)}</p>
        <p>ðŸ”§ Mantenimiento: $${totalMant.toFixed(2)}</p>
        <p>ðŸ§¾ Otros: $${totalOtros.toFixed(2)}</p>
        <p>âœ… Ganancia neta acumulada: $${totalNeto.toFixed(2)}</p>`;
    }

    // --- Fuel prices (per user) ---
    function saveFuelPrice(){
      const email=localStorage.getItem('sigra_current');if(!email){alert('No estÃ¡s logueado');return}
      const p95=parseFloat(document.getElementById('price95').value)||0;
      const p90=parseFloat(document.getElementById('price90').value)||0;
      const pd=parseFloat(document.getElementById('pricediesel').value)||0;
      if(!p95&&!p90&&!pd){alert('Ingresa al menos un precio');return}
      const key=getFuelKey(email);
      const arr=readJSON(key);
      const item={fecha:new Date().toISOString(),g95:p95,g90:p90,diesel:pd};
      arr.push(item);writeJSON(key,arr);
      document.getElementById('price95').value='';document.getElementById('price90').value='';document.getElementById('pricediesel').value='';
      loadFuelPrices();alert('Precio guardado');
    }

    function loadFuelPrices(){
      const email=localStorage.getItem('sigra_current');if(!email)return;
      const arr=readJSON(getFuelKey(email));
      const el=document.getElementById('fuelList');el.innerHTML='';
      if(!arr.length){el.innerHTML='<div class="small muted">No hay precios guardados</div>';document.getElementById('lastFuel').innerText='-';return}
      arr.slice().reverse().forEach(f=>{const d=new Date(f.fecha);const row=document.createElement('div');row.style.padding='6px 0';row.innerHTML=`<strong>${d.toLocaleDateString()}</strong> â€” 95: ${f.g95?('$'+f.g95):'-'} â€¢ 90: ${f.g90?('$'+f.g90):'-'} â€¢ DiÃ©sel: ${f.diesel?('$'+f.diesel):'-'}`;el.appendChild(row)})
      const last=arr[arr.length-1];document.getElementById('lastFuel').innerText=`95:${last.g95||'-'} 90:${last.g90||'-'} D:${last.diesel||'-'}`;
    }

    // --- PDF Export ---
    function exportPDF(){
      const email=localStorage.getItem('sigra_current');if(!email)return;const historial=readJSON(getHistKey(email));
      const { jsPDF } = window.jspdf;const doc=new jsPDF();
      doc.setFontSize(16);doc.text('Informe de Conductor - SIGRA',14,18);
      doc.setFontSize(10);doc.text('Usuario: '+email,14,24);
      const rows = historial.map((c,i)=>[i+1,new Date(c.fecha).toLocaleString(),c.tarifa.toFixed(2),c.gasolina.toFixed(2),c.carro.toFixed(2),c.mantenimiento.toFixed(2),c.otros.toFixed(2),c.neto.toFixed(2)]);
      doc.autoTable({startY:30,head:[['#','Fecha','Tarifa','Gas','Carro','Mant','Otros','Neto']],body:rows,styles:{fontSize:8}});
      doc.save('informe_SIGRA_'+email.replace(/@/g,'_')+'.pdf');
    }

    // --- Chart ---
    let chartInstance=null;
    function renderChart(){
      const email=localStorage.getItem('sigra_current');if(!email)return;
      const historial=readJSON(getHistKey(email));
      const ctx=document.getElementById('grafico').getContext('2d');
      const labels=historial.slice(-10).map(c=>new Date(c.fecha).toLocaleDateString());
      const neto=historial.slice(-10).map(c=>c.neto);
      const gas=historial.slice(-10).map(c=>c.gasolina);
      if(chartInstance)chartInstance.destroy();
      chartInstance=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Ganancia Neta',data:neto,backgroundColor:'rgba(46,204,113,0.6)'},{label:'Gasolina',data:gas,backgroundColor:'rgba(52,152,219,0.6)'}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
    }

    // --- Init ---
    function init(){
      updateUserCount();
      // hide splash after animation
      setTimeout(()=>{document.getElementById('splash').style.display='none';document.body.style.background=varOr('--bg','#f4f4f9')},5500);
      // If already logged in, show app
      const current = localStorage.getItem('sigra_current');
      if(current){showAppForUser(current)}
    }
    function varOr(name,def){try{return getComputedStyle(document.documentElement).getPropertyValue(name)||def}catch(e){return def}}

    // small helpers
    window.addEventListener('load',()=>{init();document.getElementById('splash').style.animation='fadeOut 1s ease forwards';});

  </script>
</body>
</html>
