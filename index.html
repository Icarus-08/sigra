<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIGRA - Gestor de Conductor üöñ</title>
  <style>
    :root{--primary:#007bff;--bg:#f4f4f9;--card-bg:#fff}
    body{margin:0;font-family:'Segoe UI',Roboto,Arial,sans-serif;background:black;color:#333}
    /* Splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:black;color:var(--primary);font-size:3rem;letter-spacing:.5rem;z-index:30;opacity:1}
    .sigra span{opacity:0;animation:fadeInLetter 1.5s forwards}
    .sigra span:nth-child(1){animation-delay:1.3s}
    .sigra span:nth-child(2){animation-delay:1.6s}
    .sigra span:nth-child(3){animation-delay:1.9s}
    .sigra span:nth-child(4){animation-delay:2.2s}
    .sigra span:nth-child(5){animation-delay:2.5s}
    @keyframes fadeInLetter{
      from{opacity:0;filter:blur(4px);transform:translateY(20px);}
      to{opacity:1;filter:blur(0);transform:translateY(0);}
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }
    .splash.fade-out { animation: fadeOut 1.5s ease forwards; }
    /* Containers */
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .card{width:100%;max-width:920px;background:var(--card-bg);padding:1.25rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.12)}
    .hidden{display:none}
    h1,h2,h3{margin:.25rem 0}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#6c757d}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small{font-size:.9rem;color:#555}
    .muted{color:#666}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:12px}
    .list{max-height:260px;overflow:auto;padding:8px;background:#fafafa;border-radius:8px}
    .actions{display:flex;gap:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:var(--primary);font-weight:600}
    footer{margin-top:12px;text-align:center;color:#666;font-size:.85rem}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .2s;z-index:50}
    .modal.show{visibility:visible;opacity:1}
    .modal .content{background:var(--card-bg);padding:1rem;border-radius:10px;max-width:720px;max-height:80vh;overflow:auto}
    .auth-wrap{width:420px;max-width:95vw}
    .error{color:#c0392b;font-size:.85rem;margin-top:-6px;margin-bottom:6px}
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div class="splash" id="splash">
    <div class="sigra"> 
      <span>S</span>.<span>I</span>.<span>G</span>.<span>R</span>.<span>A</span> 
    </div>
  </div>

  <!-- AUTH -->
  <div class="center-wrap" id="authWrap" style="display:none">
    <div class="card auth-wrap" id="loginCard">
      <h1 style="color:var(--primary);margin-bottom:8px">SIGRA</h1>

      <!-- LOGIN VIEW -->
      <div id="loginView">
        <input id="loginEmail" type="email" placeholder="Correo" />
        <input id="loginPass" type="password" placeholder="Contrase√±a" />
        <div class="row">
          <button onclick="doLogin()">Entrar</button>
          <button class="secondary" onclick="showRegister()">Crear Cuenta</button>
        </div>
        <p class="small muted">Al continuar aceptas nuestros <a href="#" onclick="openTerms(event)">T√©rminos y Condiciones</a></p>
      </div>

      <!-- REGISTER VIEW -->
      <div id="registerView" class="hidden">
        <h2>Crear Cuenta</h2>
        <div class="row">
          <input id="regName" placeholder="Nombre" />
          <input id="regLast" placeholder="Apellido" />
        </div>
        <input id="regEmail" type="email" placeholder="Correo" />
        <div id="emailError" class="error" style="display:none"></div>
        <input id="regPass" type="password" placeholder="Contrase√±a" />
        <div id="passError" class="error" style="display:none"></div>
        <input id="regPass2" type="password" placeholder="Confirmar Contrase√±a" />
        <div style="margin:8px 0" class="terms-checkbox">
          <input id="acceptTerms" type="checkbox" /> <label for="acceptTerms">He le√≠do y acepto los <a href="#" onclick="openTerms(event)">T√©rminos y Condiciones</a></label>
        </div>
        <div class="row">
          <button onclick="createAccount()">Crear</button>
          <button class="secondary" onclick="showLogin()">Volver</button>
        </div>
      </div>

      <div style="margin-top:10px" class="small muted">
        Usuarios registrados: <span id="userCount">0</span>
      </div>

      <!-- üî¥ Bot√≥n de reset solo visible para admin -->
      <div id="resetContainer" style="margin-top:8px;text-align:center;display:none">
        <button class="secondary" style="background:#c0392b" onclick="resetAllData()">Borrar todo</button>
      </div>
    </div>
  </div>

  <!-- MODAL TERMINOS -->
  <div class="modal" id="termsModal">
    <div class="content">
      <h2 style="color:var(--primary);text-align:center">T√©rminos y Condiciones</h2>
      <p><b>Confidencialidad de la Informaci√≥n</b><br>Todos los datos se almacenan localmente en el navegador. No se env√≠a informaci√≥n a servidores. Usa contrase√±as seguras. Esta aplicaci√≥n es para uso local/educativo.</p>
      <div style="text-align:center;margin-top:12px"><button onclick="acceptTerms()">Aceptar</button> <button class="secondary" onclick="rejectTerms()">Rechazar</button></div>
    </div>
  </div>

  <!-- MODAL DE √âXITO -->
  <div class="modal" id="successModal">
    <div class="content" style="text-align:center">
      <h2 style="color:var(--primary)">‚úÖ Cuenta creada</h2>
      <p>Tu cuenta ha sido registrada correctamente.</p>
      <div style="margin-top:12px">
        <button onclick="closeSuccessModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- GESTOR PRINCIPAL -->
  <div style="display:none;padding:18px" id="appWrap">
    <!-- Aqu√≠ ir√≠a todo el gestor -->
  </div>

  <script>
    const USERS_KEY = 'sigra_users';
    const SESSIONS_KEY = 'sigra_sessions';
    const MASTER_FUEL_KEY = 'sigra_fuel_master';
    const SPECIAL_EMAIL = 'hiroemiya1412@gmail.com';
    const PRECIOS_FIJOS = { g95: 1.25, g90: 1.10, diesel: 0.95 };

    const sanitizeEmailKey = (email)=> (email||'').trim().toLowerCase();
    function readJSON(key){try{return JSON.parse(localStorage.getItem(key))||[]}catch(e){return []}}
    function writeJSON(key,val){localStorage.setItem(key,JSON.stringify(val))}
    function hashPass(p){return btoa(p)}

    function ensureAdminExists(){
      let users = readJSON(USERS_KEY);
      if(!users.find(u=>u.email===SPECIAL_EMAIL)){
        users.push({
          name:"Admin",
          last:"SIGRA",
          email:SPECIAL_EMAIL,
          password:hashPass("2004"),
          created:new Date().toISOString()
        });
        writeJSON(USERS_KEY,users);
      }
    }

    function showRegister(){document.getElementById('loginView').classList.add('hidden');document.getElementById('registerView').classList.remove('hidden')}
    function showLogin(){document.getElementById('registerView').classList.add('hidden');document.getElementById('loginView').classList.remove('hidden')}
    function openTerms(e){e&&e.preventDefault();document.getElementById('termsModal').classList.add('show')}
    function acceptTerms(){document.getElementById('acceptTerms').checked=true;document.getElementById('termsModal').classList.remove('show')}
    function rejectTerms(){document.getElementById('acceptTerms').checked=false;document.getElementById('termsModal').classList.remove('show')}
    function updateUserCount(){document.getElementById('userCount').innerText=readJSON(USERS_KEY).length}

    function createAccount(){
      const name=document.getElementById('regName').value.trim();
      const last=document.getElementById('regLast').value.trim();
      const email=sanitizeEmailKey(document.getElementById('regEmail').value);
      const pass=document.getElementById('regPass').value;
      const pass2=document.getElementById('regPass2').value;
      const accepted=document.getElementById('acceptTerms').checked;

      if(!name||!last||!email||!pass){alert('Completa todos los campos');return}
      if(pass.length < 4){document.getElementById('passError').innerText='La contrase√±a debe tener m√≠nimo 4 caracteres';document.getElementById('passError').style.display='block';return}
      if(pass!==pass2){document.getElementById('passError').innerText='Las contrase√±as no coinciden';document.getElementById('passError').style.display='block';return}
      if(!accepted){alert('Debes aceptar los t√©rminos');return}

      const users=readJSON(USERS_KEY);
      if(users.find(u=>u.email===email)){document.getElementById('emailError').innerText='Ya existe una cuenta con ese correo';document.getElementById('emailError').style.display='block';return}
      users.push({name,last,email,password:hashPass(pass),created:new Date().toISOString()});
      writeJSON(USERS_KEY,users);

      document.getElementById('regName').value='';
      document.getElementById('regLast').value='';
      document.getElementById('regEmail').value='';
      document.getElementById('regPass').value='';
      document.getElementById('regPass2').value='';
      document.getElementById('acceptTerms').checked=false;

      updateUserCount();
      document.getElementById('successModal').classList.add('show');
    }

    function closeSuccessModal(){
      document.getElementById('successModal').classList.remove('show');
      showLogin();
    }

    function resetAllData(){
      const code = prompt("Introduce el c√≥digo para borrar todo:");
      if(code !== "Icarus_08"){
        alert("‚ùå C√≥digo incorrecto. Operaci√≥n cancelada.");
        return;
      }
      if(confirm("‚ö†Ô∏è Esto borrar√° TODAS las cuentas y sesiones. ¬øSeguro que deseas continuar?")){
        localStorage.removeItem(USERS_KEY);
        localStorage.removeItem(SESSIONS_KEY);
        localStorage.removeItem(MASTER_FUEL_KEY);
        localStorage.removeItem('sigra_current');
        updateUserCount();
        alert("‚úÖ Todos los datos fueron borrados. Puedes volver a registrar desde cero.");
        showLogin();
        document.getElementById('authWrap').style.display='flex';
        document.getElementById('appWrap').style.display='none';
        ensureAdminExists(); // vuelve a crear al admin
      }
    }

    function doLogin(){
      const email=sanitizeEmailKey(document.getElementById('loginEmail').value);
      const pass=document.getElementById('loginPass').value;
      const users=readJSON(USERS_KEY);
      const user=users.find(u=>u.email===email && u.password===hashPass(pass));
      if(!user){alert("Correo o contrase√±a incorrectos");return;}
      
      localStorage.setItem('sigra_current',email);

      // Mostrar gestor principal y ocultar login
      document.getElementById('authWrap').style.display='none';
      document.getElementById('appWrap').style.display='block';

      // Mostrar reset solo para admin
      document.getElementById('resetContainer').style.display = (email === SPECIAL_EMAIL) ? 'block' : 'none';

      alert("Bienvenido "+user.name);
    }

    function init(){
      ensureAdminExists();
      updateUserCount();
      setTimeout(()=>{
        const splash = document.getElementById('splash');
        splash.classList.add('fade-out');
        setTimeout(()=>{
          splash.style.display='none';
          document.body.style.background = "var(--bg)";
          const current=localStorage.getItem('sigra_current');
          if(!current){
            document.getElementById('authWrap').style.display='flex';
          } else {
            document.getElementById('authWrap').style.display='none';
            document.getElementById('appWrap').style.display='block';
            document.getElementById('resetContainer').style.display = (current === SPECIAL_EMAIL) ? 'block' : 'none';
          }
        },1500);
      },3000);
    }
    window.addEventListener('load',init);
  </script>
</body>
</html>
